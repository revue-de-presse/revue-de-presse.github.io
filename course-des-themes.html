<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cache busting: redirect to hash-based version if not present -->
    <script>
        (function() {
            var BUILD_HASH = '{{BUILD_HASH}}'; // Replaced by build script
            var currentHash = location.hash.replace('#v=', '');
            // Only redirect if hash is set (not template) and URL doesn't have correct version
            if (BUILD_HASH.length === 8 && currentHash !== BUILD_HASH) {
                location.replace(location.pathname + '#v=' + BUILD_HASH);
            }
        })();
    </script>

    <meta name="description" content="Visualisation animee des tendances mediatiques francaises en 2025 - Revue de Presse">
    <meta property="og:title" content="Revue de Presse 2025">
    <meta property="og:description" content="Articles de la presse francaise parmi les plus relayes sur Bluesky">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <title>Revue de Presse 2025 - Visualisation des tendances</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#006663">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Revue Presse">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://revue-de-presse.org/icon.png">
    <link rel="icon" type="image/png" href="https://revue-de-presse.org/icon.png">

    <!-- Polyfills for older browsers (IE11, older Safari/Chrome) - only loaded if needed -->
    <script>
        (function() {
            // Feature detection - skip polyfills for modern browsers
            var needsPolyfill = !window.Promise || !Array.prototype.flat || !Object.entries || !window.fetch;
            if (!needsPolyfill) return;

            var polyfillFeatures = 'es6,fetch,Promise,Array.from,Array.prototype.flat,Array.prototype.includes,Object.assign,Object.entries,Object.values,String.prototype.includes,String.prototype.startsWith,Number.isNaN,Element.prototype.classList,Element.prototype.closest,NodeList.prototype.forEach';
            var polyfillScript = document.createElement('script');
            polyfillScript.src = 'https://polyfill.io/v3/polyfill.min.js?features=' + encodeURIComponent(polyfillFeatures);
            polyfillScript.onerror = function() {
                console.warn('polyfill.io blocked, loading fallback from cdnjs');
                var fallback = document.createElement('script');
                fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/core-js/3.37.1/minified.min.js';
                fallback.onerror = function() {
                    console.warn('cdnjs fallback also failed, trying unpkg');
                    var unpkg = document.createElement('script');
                    unpkg.src = 'https://unpkg.com/core-js-bundle@3.37.1/minified.js';
                    document.head.appendChild(unpkg);
                };
                document.head.appendChild(fallback);
            };
            document.head.appendChild(polyfillScript);
        })();
    </script>

    <!-- Self-hosted fonts for faster LCP (eliminates external font requests) -->
    <link rel="preload" href="fonts/roboto-400.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="fonts/source-serif-4-400.woff2" as="font" type="font/woff2" crossorigin>
    <style>
        /* Self-hosted Roboto */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: local('Roboto'), local('Roboto-Regular'),
                 url('fonts/roboto-400.woff2') format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: local('Roboto Medium'), local('Roboto-Medium'),
                 url('fonts/roboto-500.woff2') format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* Self-hosted Source Serif 4 (variable font - all weights in one file) */
        @font-face {
            font-family: 'Source Serif 4';
            font-style: normal;
            font-weight: 400 700;
            font-display: swap;
            src: local('Source Serif 4'),
                 url('fonts/source-serif-4-400.woff2') format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* Fallback font metrics to reduce layout shift during font swap */
        @font-face {
            font-family: 'Source Serif 4 Fallback';
            src: local('Georgia'), local('Times New Roman');
            size-adjust: 105%;
            ascent-override: 95%;
            descent-override: 22%;
            line-gap-override: 0%;
        }
        @font-face {
            font-family: 'Roboto Fallback';
            src: local('Arial'), local('Helvetica');
            size-adjust: 100%;
            ascent-override: 92%;
            descent-override: 22%;
            line-gap-override: 0%;
        }
    </style>

    <!-- D3.js custom bundle (deferred for faster FCP) - 43% smaller than full D3 -->
    <script src="d3.custom.min.js" defer></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Hide JS-dependent content by default, show via JS */
        .js-required {
            display: none;
        }

        .js-enabled .js-required {
            display: block;
        }

        /* Show noscript fallback prominently when JS disabled */
        .noscript-fallback {
            font-family: 'Roboto', -apple-system, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        :root {
            --bg-primary: #fff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --text-primary: #333;
            --text-secondary: #555;
            --text-muted: #666;
            --border-color: #e0e0e0;
            --accent-primary: #006663;
            --accent-hover: #005550;
            --shadow-color: rgba(0, 0, 0, 0.25);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #f5f5f5;
            --text-secondary: #d8d8d8;
            --text-muted: #a0a0a0;
            --border-color: #4a4a6a;
            --accent-primary: #00c9bd;
            --accent-hover: #00e6d8;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Roboto', 'Roboto Fallback', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Hero Banner */
        .hero-banner {
            background: linear-gradient(135deg, #004d4a 0%, #006663 30%, #008580 70%, #00a89d 100%);
            color: #fff;
            padding: 16px 20px;
            margin-bottom: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
            min-height: 92px;
        }

        .hero-logo img {
            height: 60px;
            width: 60px;
            min-width: 60px;
            min-height: 60px;
            max-width: 60px;
            max-height: 60px;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 8px;
            display: block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .hero-content {
            flex: 1;
            text-align: center;
        }

        .hero-banner h1 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .hero-banner .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 400;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .hero-banner .subtitle .bsky-logo {
            vertical-align: middle;
            opacity: 0.9;
        }

        .hero-banner .wishes {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 6px;
        }

        .hero-banner .wishes a {
            color: #fff;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .mobile-break {
            display: none;
        }

        .hero-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.8rem;
        }

        .hero-links a {
            color: #fff;
            text-decoration: none;
            opacity: 0.85;
            transition: opacity 0.2s;
            padding: 4px 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
        }

        .hero-links a:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .chart-header-left {
            text-align: left;
        }

        .date-display {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: #006663;
            font-variant-numeric: tabular-nums;
            line-height: 1.2;
            cursor: pointer;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }

        .date-display:hover {
            color: #004d4a;
            text-decoration: underline;
        }

        .week-display {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Timeline navigation */
        .timeline-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 20px;
            margin: 16px 0;
            transition: background-color 0.3s, border-color 0.3s;
            min-height: 140px;
        }

        .timeline-months {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .timeline-months span {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 4px 2px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            position: relative;
            border-bottom: 2px solid var(--accent-primary);
            font-weight: 500;
            min-width: 0;
        }

        .timeline-months span:hover {
            background: var(--accent-primary);
            color: #fff;
            border-bottom-color: var(--accent-hover);
        }

        .timeline-months span::after {
            content: 'ðŸ“…';
            display: block;
            font-size: 0.7rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-top: 2px;
        }

        .timeline-months span:hover::after {
            opacity: 1;
        }

        /* Month calendar popup */
        .month-calendar {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: 12px;
            z-index: 1000;
            min-width: 220px;
            display: none;
        }

        .month-calendar.visible {
            display: block;
        }

        .month-calendar-header {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .month-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .month-calendar-weekdays span {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            padding: 4px 0;
            font-weight: 500;
        }

        .month-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .month-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            cursor: default;
            opacity: 0.5;
        }

        .month-calendar-day::after {
            content: none !important;
        }

        .month-calendar-day.empty {
            background: transparent;
            pointer-events: none;
        }

        .month-calendar-day.has-data {
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 1px solid var(--accent-primary);
            cursor: pointer;
            opacity: 1;
            transition: background-color 0.15s, color 0.15s;
        }

        .month-calendar-day.has-data:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        .timeline-wrapper {
            position: relative;
        }

        .timeline {
            width: 100%;
            height: 40px;
            background: var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-hover) 100%);
            border-radius: 4px 0 0 4px;
            transition: width 0.1s linear;
            pointer-events: none;
        }

        .timeline-marker {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: #c0392b;
            transform: translateX(-50%);
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .timeline-weeks {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 0 2px;
            gap: 2px 0;
        }

        .timeline-weeks span {
            text-align: center;
            min-width: 18px;
            flex-shrink: 0;
        }

        .timeline-weeks span.current {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .timeline-tooltip {
            position: absolute;
            top: -35px;
            background: #333;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            transform: translateX(-50%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .timeline-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .timeline:hover .timeline-tooltip {
            opacity: 1;
        }

        .chart-container {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 30px 40px;
            padding-bottom: 10px;
            margin: 24px 0 0 0;
            overflow-x: auto;
            transition: background-color 0.3s, border-color 0.3s;
            min-height: 560px;
            /* Reserve space to prevent CLS */
            contain: layout style;
            /* Flexbox for mobile reordering */
            display: flex;
            flex-direction: column;
        }

        /* Mobile: header -> chart -> controls -> sentiment */
        .chart-container .chart-header { order: 1; }
        .chart-container #chart { order: 2; }
        .chart-container .controls { order: 3; margin-top: 16px; }
        .chart-container .sentiment-indicator { order: 4; }

        #chart {
            display: block;
            width: 100%;
            margin: 0 auto;
            height: 480px;
            min-height: 480px;
            max-height: 480px;
            /* Prevent layout shift during D3 initialization */
            contain: layout size style;
            content-visibility: auto;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .keywords-display {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .keywords-theme {
            margin-bottom: 12px;
        }

        .keywords-theme-name {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keywords-theme-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .keyword-tag {
            font-size: 0.7rem;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            color: var(--text-secondary);
            font-family: 'Roboto', sans-serif;
        }

        /* On desktop, only show active theme keywords */
        @media (min-width: 769px) {
            .keywords-theme {
                display: none;
            }
            .keywords-theme.active {
                display: block;
            }
        }

        .controls {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls-separator {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 4px;
        }

        button {
            padding: 10px 20px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button svg {
            flex-shrink: 0;
        }

        button:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn-play {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .btn-play:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            color: #fff;
        }

        .btn-pause {
            background: #555;
            border-color: #555;
            color: #fff;
        }

        .btn-pause:hover {
            background: #444;
            border-color: #444;
            color: #fff;
        }

        .btn-reset {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .btn-sound {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .btn-sound.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .btn-help {
            padding: 8px;
            min-width: auto;
        }

        .btn-theme {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .btn-pattern {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .btn-pattern.active, .btn-theme.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .btn-mode {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
        }

        .btn-mode.daily-mode {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .btn-mode #modeBtnLabel {
            font-size: 0.75rem;
        }

        .btn-scale {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
        }

        .btn-scale.log-mode {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .btn-scale #scaleBtnLabel {
            font-size: 0.75rem;
        }

        @media (max-width: 600px) {
            .btn-mode #modeBtnLabel,
            .btn-scale #scaleBtnLabel {
                display: none;
            }
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .speed-control input {
            width: 100px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .speed-control input:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .bar-label {
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            font-weight: 500;
            fill: var(--text-primary);
        }

        [data-theme="dark"] .bar-label {
            fill: var(--text-primary);
        }

        @media (max-width: 480px) {
            .bar-label { font-size: 10px; }
            .bar-value { font-size: 9px; }
        }

        @media (min-width: 481px) and (max-width: 600px) {
            .bar-label { font-size: 11px; }
            .bar-value { font-size: 10px; }
        }

        @media (min-width: 601px) and (max-width: 768px) {
            .bar-label { font-size: 12px; }
            .bar-value { font-size: 11px; }
        }

        .bar-value {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            font-weight: 500;
            fill: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        [data-theme="dark"] .bar-value {
            fill: var(--text-secondary);
        }

        .legend {
            margin-top: 24px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: background-color 0.3s, border-color 0.3s;
            text-align: center;
        }

        .stat-value {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1;
            text-align: center;
            width: 100%;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            line-height: 1.2;
            text-align: center;
            width: 100%;
        }

        .top-headline {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-primary);
            border-radius: 0 4px 4px 0;
            padding: 20px 24px;
            margin-top: 24px;
            transition: background-color 0.3s, border-color 0.3s;
            /* Height computed for max 203 chars: 88px fixed + 72px text (3 lines) */
            min-height: 160px;
            height: 160px;
            max-height: 160px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-headline-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }

        .top-headline-text {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            /* Line clamp for desktop: 3 lines for max 203 chars at ~93 chars/line */
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .btn-start-inline {
            background: var(--accent-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn-start-inline:hover {
            background: #005550;
        }

        .headline-link {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .headline-link:hover {
            color: var(--accent-primary);
            text-decoration: underline;
        }

        [data-theme="dark"] .headline-link {
            color: #f5f5f5;
        }

        [data-theme="dark"] .headline-link:hover {
            color: var(--accent-hover);
        }

        .top-headline-source {
            font-size: 0.8rem;
            color: var(--accent-primary);
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .outlet-link {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .outlet-link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        [data-theme="dark"] .outlet-link {
            color: var(--accent-primary);
        }

        [data-theme="dark"] .outlet-link:hover {
            color: var(--accent-hover);
        }

        .outlet-logo-link {
            display: none;
            transition: transform 0.2s;
        }

        .outlet-logo-link.visible {
            display: block;
        }

        .outlet-logo-link:hover {
            transform: scale(1.1);
        }

        .outlet-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }

        .outlet-logo.visible {
            display: block;
        }

        /* Methodology */
        .methodology-foldable {
            margin-top: 24px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .methodology-foldable summary {
            padding: 16px 24px;
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .methodology-foldable summary::-webkit-details-marker {
            display: none;
        }

        .methodology-foldable summary .toggle-label {
            font-weight: 600;
        }

        .methodology-foldable summary .toggle-indicator {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .methodology-foldable summary:hover {
            background: var(--bg-tertiary);
        }

        .methodology-foldable .methodology-content {
            padding: 0 24px 24px 24px;
        }

        .methodology-foldable .methodology-content p {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .methodology-foldable .methodology-content p:last-child {
            margin-bottom: 0;
        }

        .methodology-foldable .methodology-content strong {
            color: var(--text-primary);
        }

        /* Engagement Example in Methodology */
        .engagement-example {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .engagement-example h4 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }

        .engagement-example blockquote {
            font-style: italic;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-primary);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .engagement-example blockquote cite {
            display: block;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-style: normal;
        }

        .engagement-example blockquote cite a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .engagement-example blockquote cite a:hover {
            text-decoration: underline;
        }

        .example-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 6px;
            margin-left: 4px;
        }

        .example-avatar-link {
            display: inline;
        }

        .engagement-example > p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 12px 0;
        }

        .engagement-example .formula-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .engagement-example .formula-box p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            line-height: 1.5;
        }

        .engagement-example .formula-box code {
            display: block;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .engagement-example .formula-box code strong {
            color: var(--accent-primary);
        }

        .engagement-example .quote-text-link {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }

        .engagement-example .quote-text-link:hover {
            color: var(--accent-primary);
        }

        /* Share buttons */
        .share-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .share-section h4 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .share-btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .share-btn-bluesky {
            background: #0085ff;
            color: white;
        }

        .share-btn-bluesky:hover {
            background: #006ed4;
        }

        .share-btn-x {
            background: #888;
            color: #ccc;
            cursor: pointer;
            opacity: 0.6;
        }

        .share-btn-x:hover {
            background: #666;
            opacity: 0.8;
        }

        .share-btn-mastodon {
            background: #6364ff;
            color: white;
        }

        .share-btn-mastodon:hover {
            background: #5152d9;
        }

        .share-btn-linkedin {
            background: #0077b5;
            color: white;
        }

        .share-btn-linkedin:hover {
            background: #006097;
        }

        .share-btn-email {
            background: #006663;
            color: white;
        }

        .share-btn-email:hover {
            background: #005550;
        }

        .share-btn-copy {
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            min-width: 140px;
            justify-content: center;
        }

        .share-btn-copy:hover {
            background: #f0f0f0;
            border-color: #006663;
        }

        .share-btn-copy.copied {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .share-btn-signal {
            background: #3a76f0;
            color: white;
        }

        .share-btn-signal:hover {
            background: #2a5fc0;
        }

        .share-btn-deltachat {
            background: #f5f5f5;
            color: #364e59;
            border: 1px solid #ccc;
        }

        .share-btn-deltachat:hover {
            background: #e8e8e8;
            border-color: #364e59;
        }

        .share-btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .share-btn-whatsapp:hover {
            background: #1da851;
        }

        /* Zen Mode - Tabular Summary */
        .zen-mode-section {
            margin-top: 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .zen-mode-toggle {
            width: 100%;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            transition: background-color 0.2s;
        }

        .zen-mode-toggle:hover {
            background: var(--bg-tertiary);
        }

        .toggle-label {
            font-weight: 600;
        }

        .toggle-indicator {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .zen-mode-content {
            display: none;
            padding: 0 24px 24px 24px;
            background: var(--bg-primary);
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .zen-mode-content.visible {
            display: block;
        }

        .zen-mode-content h3 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1.1rem;
            color: var(--accent-primary);
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .zen-mode-content h3:first-child {
            margin-top: 0;
        }

        .zen-mode-content .sentiment-emoji {
            font-size: 1.2em;
            margin-left: 8px;
            cursor: help;
        }

        .zen-mode-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .zen-mode-content th,
        .zen-mode-content td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .zen-mode-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .zen-mode-content td {
            color: var(--text-secondary);
        }

        .zen-mode-content .score {
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }

        .zen-mode-content .week-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .zen-mode-content .week-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            scroll-margin-top: 70px;
        }

        /* Week navigation bar */
        .week-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-primary);
            padding: 12px 16px;
            margin: 0 -24px 0 -24px;
            border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 90px;
        }

        .week-content-spacer {
            height: 20px;
        }

        .week-nav-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .week-nav-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 4px 0;
            white-space: nowrap;
        }

        .week-nav-seasons {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            flex: 1;
        }

        .week-nav-season {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .week-nav-season-label {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .week-nav-inner {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .week-nav-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 26px;
            height: 26px;
            padding: 0 4px;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-radius: 4px;
            text-decoration: none;
            transition: background 0.15s, color 0.15s;
        }

        .week-nav-item:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        .week-nav-item.active {
            background: var(--accent-primary);
            color: #fff;
        }

        @media (max-width: 600px) {
            .week-nav {
                padding: 8px 12px;
                margin: 0 -24px;
            }
            .week-nav-row {
                gap: 8px;
            }
            .week-nav-seasons {
                gap: 10px;
            }
            .week-nav-season {
                gap: 4px;
            }
            .week-nav-season-label {
                font-size: 0.6rem;
            }
            .week-nav-item {
                min-width: 20px;
                height: 20px;
                font-size: 0.55rem;
                padding: 0 2px;
            }
            .week-nav-inner {
                gap: 2px;
            }
        }

        @media (max-width: 480px) {
            .week-nav {
                padding: 6px 10px;
            }
            .week-nav-seasons {
                gap: 8px;
            }
            .week-nav-season-label {
                font-size: 0.55rem;
            }
            .week-nav-item {
                min-width: 18px;
                height: 18px;
                font-size: 0.5rem;
            }
        }

        @media (max-width: 375px) {
            .week-nav {
                padding: 4px 8px;
            }
            .week-nav-row {
                gap: 6px;
            }
            .week-nav-seasons {
                gap: 6px;
            }
            .week-nav-season {
                gap: 3px;
            }
            .week-nav-season-label {
                font-size: 0.5rem;
            }
            .week-nav-item {
                min-width: 16px;
                height: 16px;
                font-size: 0.45rem;
                border-radius: 3px;
            }
            .week-nav-inner {
                gap: 1px;
            }
        }

        /* Week bar charts */
        .zen-mode-content .week-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .zen-mode-content .week-bar-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .zen-mode-content .week-bar-label {
            flex: 0 0 180px;
            font-size: 0.8rem;
            color: var(--text-primary);
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .zen-mode-content .week-bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .zen-mode-content .week-bar {
            height: 20px;
            border-radius: 3px;
            min-width: 4px;
            transition: width 0.3s ease;
        }

        .zen-mode-content .week-bar-value {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            .zen-mode-content .week-bar-label {
                flex: 0 0 100px;
                font-size: 0.7rem;
            }
            .zen-mode-content .week-bar-value {
                font-size: 0.65rem;
            }
        }

        .zen-mode-content .week-bar {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .zen-mode-content .week-bar:hover {
            opacity: 0.85;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Colorblind-friendly patterns for week bars */
        .zen-mode-content .week-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        /* Patterns only visible when colorblind mode is enabled */
        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="stripe"]::after {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.35) 2px,
                rgba(255,255,255,0.35) 4px
            );
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="dots"]::after {
            background-image: radial-gradient(circle, rgba(255,255,255,0.4) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="cross"]::after {
            background:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 3px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 3px);
            background-size: 6px 6px;
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="diagonal"]::after {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(255,255,255,0.35) 3px,
                rgba(255,255,255,0.35) 5px
            );
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="zigzag"]::after {
            background: repeating-linear-gradient(
                135deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.35) 2px,
                rgba(255,255,255,0.35) 4px
            );
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="horizontal"]::after {
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.35) 2px,
                rgba(255,255,255,0.35) 4px
            );
        }

        body.patterns-enabled .zen-mode-content .week-bar[data-pattern="vertical"]::after {
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.35) 2px,
                rgba(255,255,255,0.35) 4px
            );
        }

        /* Word cloud popup */
        .wordcloud-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .wordcloud-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .wordcloud-popup {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .wordcloud-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px 8px;
            line-height: 1;
        }

        .wordcloud-close:hover {
            color: var(--text-primary);
        }

        .wordcloud-header {
            margin-bottom: 20px;
            padding-right: 32px;
        }

        .wordcloud-header h3 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            color: var(--accent-primary);
            margin: 0 0 8px 0;
        }

        .wordcloud-header p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        .wordcloud-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            line-height: 1.8;
        }

        .wordcloud-word {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: transform 0.15s, background 0.15s;
        }

        .wordcloud-word:hover {
            transform: scale(1.1);
            background: var(--accent-primary);
            color: #fff;
        }

        .wordcloud-word.size-1 { font-size: 0.75rem; opacity: 0.7; }
        .wordcloud-word.size-2 { font-size: 0.9rem; opacity: 0.8; }
        .wordcloud-word.size-3 { font-size: 1.1rem; }
        .wordcloud-word.size-4 { font-size: 1.3rem; font-weight: 500; }
        .wordcloud-word.size-5 { font-size: 1.6rem; font-weight: 600; }

        .zen-mode-content .top-quote {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-left: 3px solid var(--accent-primary);
            margin: 12px 0 24px 0;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .zen-mode-content .quote-source {
            font-style: normal;
            font-size: 0.8rem;
            color: var(--accent-primary);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zen-mode-content .quote-avatar {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
        }

        .zen-mode-content .quote-avatar-link {
            display: flex;
            transition: transform 0.2s;
        }

        .zen-mode-content .quote-avatar-link:hover {
            transform: scale(1.1);
        }

        .zen-mode-content .quote-source-link {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .zen-mode-content .quote-source-link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        .zen-mode-content .quote-text-link {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }

        .zen-mode-content .quote-text-link:hover {
            color: var(--accent-primary);
        }

        .zen-mode-content .top-quote .quote-text-link {
            display: block;
        }

        /* Keywords foldable section (in Semainier) */
        .keywords-foldable {
            margin-top: 24px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .keywords-foldable summary {
            padding: 16px 24px;
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .keywords-foldable summary::-webkit-details-marker {
            display: none;
        }

        .keywords-foldable summary .toggle-label {
            font-weight: 600;
        }

        .keywords-foldable summary .toggle-indicator {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .keywords-foldable summary:hover {
            background: var(--bg-tertiary);
        }

        .keywords-foldable .keywords-content {
            padding: 0 24px 24px 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            grid-auto-rows: 1fr;
            gap: 16px;
        }

        .keyword-group {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .keyword-group h4 {
            margin: 0 0 8px 0;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .keyword-group .keyword-list {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0;
            flex: 1;
        }

        .keyword-group-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .keyword-group-footer .link-count-btn {
            font-size: 0.7rem;
            color: var(--accent-primary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .keyword-group-footer .link-count-btn:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        /* Publications popup */
        .publications-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .publications-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .publications-popup {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .publications-overlay.visible .publications-popup {
            transform: translateY(0);
        }

        .publications-popup-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .publications-popup-title {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .publications-popup-title .theme-indicator {
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }

        .publications-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            transition: color 0.2s;
        }

        .publications-popup-close:hover {
            color: var(--text-primary);
        }

        .publications-popup-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
            -webkit-overflow-scrolling: touch;
        }

        .publication-item {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .publication-item:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .publication-item:last-child {
            margin-bottom: 0;
        }

        .publication-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .publication-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .publication-item-avatar-fallback {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .publication-item-meta {
            flex: 1;
        }

        .publication-item-author {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .publication-item-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .publication-item-text {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .publication-item-text a.publication-text-link {
            color: var(--accent-primary);
            text-decoration: none;
            word-break: break-all;
        }

        .publication-item-text a.publication-text-link:hover {
            text-decoration: underline;
        }

        .publication-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .publication-item-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .publication-item-stats .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .publication-item-stats .stat-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .publication-item-stats .stat-icon.heart {
            color: #e0245e;
        }

        .publication-item-stats .stat-icon.repost {
            color: #17bf63;
        }

        .publication-item-stats .stat-value {
            font-variant-numeric: tabular-nums;
        }

        .publication-item-link {
            font-size: 0.8rem;
            color: var(--accent-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .publication-item-link:hover {
            text-decoration: underline;
        }

        .publication-item-link .bsky-logo {
            width: 16px;
            height: 16px;
        }

        .publications-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .publications-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .keyword-group-footer .link-count {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .keyword-group-footer .json-copy-link {
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--accent-primary);
            text-decoration: none;
            padding: 2px 6px;
            border: 1px solid var(--accent-primary);
            border-radius: 3px;
            transition: background-color 0.2s, color 0.2s;
        }

        .keyword-group-footer .json-copy-link:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        .keyword-group-footer .json-copy-link.copied {
            background: var(--accent-primary);
            color: #fff;
        }

        .keywords-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .keywords-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .keywords-toggle svg {
            transition: transform 0.3s;
        }

        .keywords-toggle[aria-expanded="true"] svg {
            transform: rotate(180deg);
        }

        .keywords-content {
            margin-top: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .keywords-content[hidden] {
            display: none;
        }

        .keyword-theme {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .keyword-theme h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .keyword-theme .theme-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .keyword-tag {
            display: inline-block;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Sentiment filter */
        .sentiment-filter {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        .sentiment-filter-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .sentiment-filter-btn {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 3px 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .sentiment-filter-btn:hover {
            opacity: 1;
            border-color: var(--accent-primary);
        }

        .sentiment-filter-btn.active {
            opacity: 1;
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .sentiment-filter-btn .filter-count {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .sentiment-filter-btn.active .filter-count {
            color: rgba(255,255,255,0.8);
        }

        .week-hidden {
            display: none !important;
        }

        .zen-mode-content .methodology-section {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 2px solid var(--accent-primary);
        }

        .zen-mode-content .methodology-section h3 {
            color: var(--accent-primary);
            margin-bottom: 16px;
        }

        .zen-mode-content .methodology-section p {
            margin: 12px 0;
            line-height: 1.6;
        }

        .zen-mode-content .methodology-section ul {
            margin: 16px 0;
            padding-left: 24px;
        }

        .zen-mode-content .methodology-section li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .zen-mode-content .methodology-section .formula {
            background: var(--bg-tertiary);
            padding: 16px 20px;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            text-align: center;
            margin: 20px 0;
        }

        .zen-mode-content .methodology-section .example-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 20px;
        }

        .zen-mode-content .methodology-section .example-calc {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-left: 3px solid var(--accent-primary);
            font-family: 'Roboto Mono', monospace;
            font-size: 0.95rem;
            margin: 12px 0;
        }

        .zen-mode-content .methodology-section .example-calculation {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-top: 24px;
        }

        .zen-mode-content .methodology-section .example-calculation h4 {
            margin-bottom: 12px;
            color: var(--accent-primary);
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
        }

        .zen-mode-content .methodology-section .example-calculation blockquote {
            font-style: italic;
            border-left: 3px solid var(--accent-primary);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
        }

        .zen-mode-content .methodology-section .example-calculation cite {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--accent-primary);
            font-style: normal;
        }

        .zen-mode-content .methodology-section .formula-example {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 6px;
            margin-top: 16px;
        }

        .zen-mode-content .methodology-section .formula-example p {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
        }

        .zen-mode-content .methodology-section .formula-example code {
            display: block;
            font-family: 'Roboto Mono', monospace;
            line-height: 1.8;
            font-size: 0.9rem;
        }

        @media print {
            .zen-mode-content {
                display: block !important;
                max-height: none;
            }
            .zen-mode-toggle {
                display: none;
            }
            .js-required {
                display: none !important;
            }
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        footer a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer .build-version {
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        svg {
            overflow: visible;
        }

        /* Modal aide clavier */
        #keyboardHelpModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .help-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .help-modal-content {
            position: relative;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 24px 32px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .help-modal-content h3 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 1.3rem;
            color: var(--accent-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .help-shortcuts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .shortcut-group h4 {
            font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }

        .shortcut {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .shortcut kbd {
            display: inline-block;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            margin-right: 4px;
            color: var(--text-primary);
        }

        .help-close-btn {
            display: block;
            margin: 20px auto 0;
            padding: 8px 24px;
            background: var(--accent-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
        }

        .help-close-btn:hover {
            background: var(--accent-hover);
        }

        @media (max-width: 600px) {
            .help-shortcuts {
                grid-template-columns: 1fr;
            }
            .help-modal-content {
                margin: 20px;
                padding: 16px 20px;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .date-display {
                font-size: 1.6rem;
            }
            .chart-container {
                padding: 15px 10px;
                padding-bottom: 10px;
            }
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .controls {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                gap: 6px;
            }
            button {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            .speed-control {
                width: 100%;
                justify-content: center;
                margin-top: 6px;
            }
            .speed-control input {
                width: 80px;
            }
            .keywords-display {
                display: none;
            }
            .timeline-months {
                font-size: 0.6rem;
            }
            .timeline-weeks {
                gap: 3px 0;
            }
            .timeline-weeks span {
                font-size: 0.55rem;
                min-width: 16px;
            }
            .timeline {
                height: 28px;
            }
            .hero-banner {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 12px 16px;
                gap: 4px;
                min-height: auto;
            }
            .hero-logo {
                display: none;
            }
            .hero-logo img {
                height: 24px;
                width: 24px;
                min-width: 24px;
                min-height: 24px;
                max-width: 24px;
                max-height: 24px;
                vertical-align: middle;
            }
            .hero-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
            }
            .hero-banner h1 {
                font-size: 1.2rem;
                text-align: center;
                order: 1;
            }
            .hero-banner .subtitle {
                font-size: 0.75rem;
                margin-bottom: 0;
                text-align: center;
                order: 2;
            }
            .hero-banner .subtitle::before {
                content: '';
                display: inline-block;
                width: 24px;
                height: 24px;
                background-image: url('https://avatars.githubusercontent.com/u/6276394?s=200&v=4');
                background-size: contain;
                background-repeat: no-repeat;
                vertical-align: middle;
                margin-right: 6px;
                border-radius: 4px;
            }
            .hero-banner .wishes {
                text-align: center;
                order: 3;
            }
            .hero-links {
                display: none;
            }
            .btn-help {
                display: none;
            }
            .help-separator {
                display: none;
            }
            .mobile-break {
                display: block;
            }
            .hero-banner .wishes {
                font-size: 0.8rem;
                margin-bottom: 4px;
            }
            .hero-links {
                justify-content: center;
                font-size: 0.7rem;
                gap: 8px;
            }
            /* Height for 481-768px: 88px fixed + 96px text (4 lines at ~60 chars/line) */
            .top-headline {
                min-height: 190px;
                height: 190px;
                max-height: 190px;
            }
            .top-headline-text {
                -webkit-line-clamp: 4;
            }
        }

        /* iPhone 14 Pro Max: 430px width */
        @media (max-width: 480px) {
            .timeline-weeks {
                gap: 4px 0;
            }
            .timeline-weeks span {
                font-size: 0.5rem;
                min-width: 14px;
            }
            .hero-banner {
                padding: 10px 12px;
                gap: 4px 6px;
            }
            .hero-logo img {
                height: 28px;
                width: 28px;
                min-width: 28px;
                min-height: 28px;
                max-width: 28px;
                max-height: 28px;
            }
            .hero-banner h1 {
                font-size: 1rem;
            }
            .hero-banner .subtitle {
                font-size: 0.7rem;
            }
            .hero-banner .wishes {
                font-size: 0.75rem;
            }
            /* Height for 320-480px: 88px fixed + 144px text (6 lines at ~39 chars/line) */
            .top-headline {
                min-height: 240px;
                height: 240px;
                max-height: 240px;
            }
            .top-headline-text {
                -webkit-line-clamp: 6;
            }
        }

        /* iPhone SE, smaller devices: 375px and below */
        @media (max-width: 375px) {
            .timeline-weeks {
                gap: 4px 0;
            }
            .timeline-weeks span {
                font-size: 0.45rem;
                min-width: 12px;
            }
            .hero-banner {
                padding: 8px 10px;
                gap: 3px 6px;
            }
            .hero-logo img {
                height: 24px;
                width: 24px;
                min-width: 24px;
                min-height: 24px;
                max-width: 24px;
                max-height: 24px;
            }
            .hero-banner h1 {
                font-size: 0.95rem;
            }
            .hero-banner .subtitle {
                font-size: 0.6rem;
            }
            .hero-banner .wishes {
                font-size: 0.65rem;
            }
            .hero-links {
                font-size: 0.6rem;
                gap: 4px;
            }
            /* Height for <375px: 88px fixed + 168px text (7 lines at ~32 chars/line) */
            .top-headline {
                min-height: 260px;
                height: 260px;
                max-height: 260px;
            }
            .top-headline-text {
                -webkit-line-clamp: 7;
            }
        }

        /* ===== SENTIMENT INDICATOR ===== */
        .sentiment-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            width: 100px;
            height: 95px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sentiment-emoji {
            font-size: 2.5rem;
            line-height: 1;
            transition: transform 0.3s ease, opacity 0.2s ease;
        }

        .sentiment-emoji.changing {
            animation: emojiPop 0.4s ease-out;
        }

        @keyframes emojiPop {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .sentiment-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .sentiment-bar {
            width: 60px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .sentiment-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }

        /* Sentiment colors */
        .sentiment-indicator[data-sentiment="very_negative"] .sentiment-fill {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
        }
        .sentiment-indicator[data-sentiment="negative"] .sentiment-fill {
            background: linear-gradient(90deg, #e67e22, #f39c12);
        }
        .sentiment-indicator[data-sentiment="neutral"] .sentiment-fill {
            background: linear-gradient(90deg, #7f8c8d, #95a5a6);
        }
        .sentiment-indicator[data-sentiment="positive"] .sentiment-fill {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        .sentiment-indicator[data-sentiment="very_positive"] .sentiment-fill {
            background: linear-gradient(90deg, #16a085, #1abc9c);
        }

        @media (max-width: 768px) {
            .sentiment-indicator {
                top: 8px;
                right: 8px;
                padding: 6px 8px;
                width: 56px;
                height: 56px;
                gap: 2px;
            }
            .sentiment-emoji {
                font-size: 1.4rem;
            }
            .sentiment-label {
                font-size: 0.5rem;
            }
            .sentiment-bar {
                width: 36px;
                height: 3px;
            }
        }

        /* ===== SMOOTH BAR TRANSITIONS ===== */
        .bar {
            transition: opacity 0.3s ease-out;
        }

        .bar.entering {
            animation: barEnter 0.5s ease-out forwards;
        }

        .bar.exiting {
            animation: barExit 0.3s ease-in forwards;
        }

        @keyframes barEnter {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes barExit {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        .bar-label {
            transition: opacity 0.3s ease-out;
        }

        .bar-value {
            transition: opacity 0.3s ease-out;
        }

        /* Pattern overlay for colorblind accessibility */
        .pattern-overlay {
            pointer-events: none;
            opacity: 1;
        }

        [data-theme="dark"] .pattern-overlay {
            opacity: 0.9;
        }

        /* "Autres" fixed at bottom styling */
        .bar.autres-bar {
            opacity: 0.6;
        }

        .bar.autres-bar rect {
            opacity: 0.8;
        }
    </style>
    <script>document.documentElement.classList.add('js-enabled');</script>
</head>
<body>
    <div class="container js-required">
        <!-- Hero Banner -->
        <header class="hero-banner">
            <a href="https://revue-de-presse.org" target="_blank" class="hero-logo">
                <img src="https://avatars.githubusercontent.com/u/6276394?s=200&v=4" alt="revue-de-presse.org">
            </a>
            <div class="hero-content">
                <h1>Revue de Presse 2025</h1>
                <p class="subtitle">Articles de la presse franÃ§aise<br>parmi les plus relayÃ©s en 2025 <svg class="bsky-logo" width="18" height="18" viewBox="0 0 600 530" aria-label="Bluesky" role="img"><path fill="currentColor" d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/></svg></p>
                <p class="wishes"><a href="https://revue-de-presse.org" target="_blank" rel="noopener">Revue-de-presse.org</a> vous souhaite <br class="mobile-break">une excellente nouvelle annÃ©e 2026 !</p>
                <div class="hero-links">
                    <a href="https://revue-de-presse.org" target="_blank">Site web</a>
                    <a href="https://play.google.com/store/apps/details?id=org.revue_2_presse" target="_blank">Application Android</a>
                </div>
            </div>
        </header>

        <div class="timeline-container">
            <div class="timeline-months" id="timelineMonths"></div>
            <div class="timeline-wrapper">
                <div class="timeline" id="timeline">
                    <div class="timeline-progress" id="timelineProgress"></div>
                    <div class="timeline-marker" id="timelineMarker"></div>
                    <div class="timeline-tooltip" id="timelineTooltip"></div>
                </div>
            </div>
            <div class="timeline-weeks" id="timelineWeeks"></div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-header-left">
                    <div class="date-display" id="currentDate" title="Voir cette journÃ©e sur revue-de-presse.org">Mars 2025</div>
                    <div class="week-display" id="weekDisplay">Semaine 10</div>
                </div>
            </div>
            <svg id="chart"></svg>
            <div class="controls">
                <!-- Animation controls -->
                <button class="btn-play" id="playBtn" title="Lancer l'animation" aria-label="Lancer l'animation"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5,3 19,12 5,21"/></svg> Lancer</button>
                <button class="btn-pause" id="pauseBtn" title="Mettre en pause" aria-label="Mettre en pause"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg> Pause</button>
                <button class="btn-reset" id="resetBtn" title="Recommencer depuis le dÃ©but" aria-label="Recommencer depuis le dÃ©but"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Rejouer</button>
                <div class="speed-control">
                    <label for="speedSlider">Vitesse</label>
                    <input type="range" id="speedSlider" min="100" max="1000" value="500" step="50" aria-label="Vitesse de l'animation" aria-valuemin="100" aria-valuemax="1000" aria-valuenow="500">
                    <span id="speedLabel" aria-live="polite">1x</span>
                </div>
                <button class="btn-sound" id="soundBtn" title="Activer ou dÃ©sactiver le son" aria-label="Activer ou dÃ©sactiver le son" aria-pressed="false"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Son</button>
                <div class="controls-separator" aria-hidden="true"></div>
                <!-- Chart mode controls -->
                <button class="btn-mode daily-mode" id="modeBtn" title="Mode d'animation: Quotidien (vitesse rÃ©duite)" aria-label="Changer le mode d'animation" aria-pressed="true">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" class="icon-cumul" style="display:none"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 5-6"/></svg>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" class="icon-daily"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="8"/><rect x="14" y="6" width="3" height="12"/></svg>
                    <span id="modeBtnLabel">Quotidien</span>
                </button>
                <button class="btn-scale" id="scaleBtn" title="Ã‰chelle: LinÃ©aire" aria-label="Changer l'Ã©chelle" aria-pressed="false">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 3v18h18"/><path d="M7 17L21 3"/></svg>
                    <span id="scaleBtnLabel">Lin</span>
                </button>
                <div class="controls-separator" aria-hidden="true"></div>
                <!-- Accessibility controls -->
                <button class="btn-pattern active" id="patternBtn" title="DÃ©sactiver les motifs pour daltonisme" aria-label="DÃ©sactiver les motifs pour daltonisme" aria-pressed="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg></button>
                <button class="btn-theme" id="themeBtn" title="Mode sombre" aria-label="Activer le mode sombre" aria-pressed="false"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
                <div class="controls-separator help-separator" aria-hidden="true"></div>
                <!-- Help -->
                <button class="btn-help" id="helpBtn" title="Raccourcis clavier (?)" aria-label="Afficher les raccourcis clavier"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button>
            </div>
            <!-- Sentiment Indicator -->
            <div class="sentiment-indicator" id="sentimentIndicator" data-sentiment="neutral">
                <div class="sentiment-emoji" id="sentimentEmoji">ðŸ˜</div>
                <div class="sentiment-label" id="sentimentLabel">Neutre</div>
                <div class="sentiment-bar">
                    <div class="sentiment-fill" id="sentimentFill" style="width: 50%"></div>
                </div>
            </div>
        </div>

        <div class="top-headline" id="topHeadline">
            <div class="top-headline-label">Article le plus engageant du jour</div>
            <div class="top-headline-text" id="headlineText"><button class="btn-start-inline" id="startBtnInline" title="Lancer l'animation"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5,3 19,12 5,21"/></svg> Lancer l'animation</button></div>
            <div class="top-headline-source" id="headlineSource">
                <a id="outletLogoLink" href="#" target="_blank" rel="noopener" class="outlet-logo-link">
                    <img class="outlet-logo" id="outletLogo" src="" alt="" onerror="this.parentElement.classList.remove('visible')">
                </a>
                <a id="outletName" href="#" target="_blank" rel="noopener" class="outlet-link"></a>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalArticles">0</div>
                <div class="stat-label">Articles analysÃ©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEngagement">0</div>
                <div class="stat-label">Engagement total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="leadingTheme">-</div>
                <div class="stat-label">ThÃ¨me dominant</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="daysProcessed">0</div>
                <div class="stat-label">Jours traitÃ©s</div>
            </div>
        </div>

        <!-- Semainier placeholder - will be populated by build script -->
        <div id="semainierPlaceholder"></div>

        <div class="legend" id="legend"></div>

        <details class="methodology-foldable" id="methodologyFoldable">
            <summary title="Afficher ou masquer la mÃ©thodologie" aria-label="Afficher ou masquer la mÃ©thodologie">
                <span class="toggle-label">D'oÃ¹ viennent ces nombres ?</span>
                <span class="toggle-indicator">Afficher â–¼</span>
            </summary>
            <div class="methodology-content">
                <p>Cette visualisation rassemble les articles partagÃ©s par la presse franÃ§aise sur Bluesky entre le 4 mars 2025 et le 31 dÃ©cembre 2025. Pour chaque article, nous rÃ©cupÃ©rons deux indicateurs fournis par la plateforme : les <strong>likes</strong> (mentions Â« j'aime Â») et les <strong>reposts</strong> (partages). Ces deux valeurs sont combinÃ©es en un Â« score d'engagement Â» selon la formule : <strong>likes + (reposts Ã— 2)</strong>. Les reposts comptent double car partager un article demande plus d'implication et lui donne plus de visibilitÃ© qu'un simple like.</p>
                <p>Chaque article est ensuite analysÃ© par recherche de mots-clÃ©s (Â« Trump Â», Â« Ukraine Â», Â« Macron Â», etc.) pour l'associer Ã  une ou plusieurs thÃ©matiques. Le graphique animÃ© montre l'<strong>engagement cumulÃ©</strong> par thÃ¨me au fil du temps : Ã  chaque jour, les scores s'additionnent, et les sujets qui suscitent le plus de rÃ©actions montent dans le classement.</p>
                <p>Il s'agit d'une approximation : cette mÃ©thode ne tient pas compte de la qualitÃ© des articles, des doublons Ã©ventuels, ni du fait que certains mÃ©dias ont plus d'abonnÃ©s que d'autres. Elle mesure simplement Â« quels sujets ont gÃ©nÃ©rÃ© le plus de likes et de partages sur Bluesky Â» sur la base d'une correspondance par mots-clÃ©s â€” Ã  prendre donc avec Â«&nbsp;un grain de sel&nbsp;Â»&nbsp;ðŸ§‚.</p>

                <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);">

                <h4 style="margin-bottom: 12px; font-family: 'Source Serif 4', 'Source Serif 4 Fallback', Georgia, serif; font-size: 0.95rem; font-weight: 600; color: var(--accent-primary);">Formule de calcul</h4>
                <p>Le score d'engagement mesure la visibilitÃ© et l'impact d'une publication sur Bluesky. Il prend en compte deux indicateurs :</p>
                <ul style="margin: 12px 0; padding-left: 24px; font-size: 0.85rem; color: var(--text-secondary);">
                    <li><strong>Les mentions Â« j'aime Â»</strong> (likes) : chaque like compte pour 1 point</li>
                    <li><strong>Les republications</strong> (reposts) : chaque repost compte pour 2 points, car il amplifie la portÃ©e du message auprÃ¨s d'une nouvelle audience</li>
                </ul>
                <p class="formula-box" style="background: var(--bg-tertiary); padding: 16px 20px; border-radius: 6px; font-family: 'Roboto Mono', monospace; text-align: center; margin: 16px 0;"><strong>Score d'engagement = likes + (reposts Ã— 2)</strong></p>

                <!-- Engagement example will be populated dynamically -->
                <div id="engagementExample" class="engagement-example"></div>
            </div>
        </details>

        <div class="share-section">
            <h4>Partager, c'est aimer ðŸŽ</h4>
            <div class="share-buttons">
                <button id="copyLink" class="share-btn share-btn-copy" title="Copier le lien dans le presse-papiers" aria-label="Copier le lien">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    <span id="copyLinkText">Copier le lien</span>
                </button>
                <a href="#" id="shareDeltaChat" class="share-btn share-btn-deltachat" title="Partager via Delta Chat" aria-label="Partager via Delta Chat">
                    <svg viewBox="0 0 48 48" aria-hidden="true"><defs><linearGradient id="dc-grad" x1="31.957" x2="-45.041" y1="29.751" y2="-18.592" gradientTransform="matrix(.93766 0 0 .93766 1.5426 1.72)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#364e59"/><stop offset="1" stop-color="#364e59" stop-opacity="0"/></linearGradient></defs><path fill="#fff" stroke="#000" stroke-linejoin="round" stroke-opacity=".439" stroke-width=".574" d="m24.015 1.287c-12.549 0-22.728 10.179-22.728 22.728s10.179 22.728 22.728 22.728c14.338-0.343 9.614-4.703 23.698 0.969-7.546-13.002-1.083-13.33-0.969-23.698 0-12.549-10.179-22.728-22.728-22.728z"/><path fill="url(#dc-grad)" d="m23.982 5.31c-10.336.126-18.72 8.62-18.72 18.965 0 10.346 8.384 18.635 18.72 18.51 9.828-.04 7.517-5.49 18.38-.443-5.95-9.296.202-10.534.34-18.522 0-10.346-8.384-18.635-18.72-18.51z"/><path fill="#fff" d="m21.689 23.636q-1.028-1.151-2.858-2.755-2.015-1.768-2.714-2.776-.699-1.028-.699-2.241 0-1.809 1.686-2.837 1.686-1.049 4.4-1.049t4.729.925q2.035.925 2.035 2.55 0 .78-.493 1.295-.493.514-1.151.514-.946 0-2.22-1.419-1.296-1.439-2.2-2.015-.884-.596-2.077-.596-1.521 0-2.508.678-.966.679-.966 1.727 0 .987.802 1.85t4.132 3.146q3.557 2.447 5.017 3.824 1.48 1.378 2.405 3.351.925 1.974.925 4.174 0 3.865-2.734 6.826-2.714 2.94-6.353 2.94-3.31 0-5.592-2.364-2.282-2.364-2.282-6.312 0-3.803 2.508-6.353 2.529-2.549 6.209-3.084zm.905.946q-5.901.966-5.901 8.1 0 3.68 1.46 5.716 1.48 2.035 3.433 2.035 2.036 0 3.351-1.953 1.316-1.974 1.316-5.325 0-4.852-3.66-8.573z" transform="scale(1.0 .90)"/></svg>
                    Delta Chat
                </a>
                <a href="#" id="shareSignal" class="share-btn share-btn-signal" title="Partager via Signal (ouvre le menu de partage)" aria-label="Partager sur Signal">
                    <svg viewBox="0 0 128 128" fill="currentColor" aria-hidden="true"><path d="M64 0c3.32 0 6.582.253 9.766.74l-.916 5.931A58.5 58.5 0 0 0 64 6c-3.009 0-5.964.23-8.85.67L54.235.74A64.5 64.5 0 0 1 64 0m15.188 1.813-1.424 5.83a57.7 57.7 0 0 1 16.352 6.779l3.115-5.13a63.6 63.6 0 0 0-18.043-7.479m22.635 10.554-3.545 4.84a58.3 58.3 0 0 1 12.514 12.516l4.841-3.546a64.4 64.4 0 0 0-13.81-13.81m16.885 18.403-5.129 3.115a57.7 57.7 0 0 1 6.778 16.351l5.83-1.423a63.6 63.6 0 0 0-7.479-18.044Zm8.552 23.465-5.931.915A58.4 58.4 0 0 1 122 64c0 3.01-.229 5.965-.671 8.85l5.931.916c.487-3.184.74-6.446.74-9.766s-.253-6.581-.74-9.765m-13.681 39.881a57.7 57.7 0 0 0 6.778-16.352l5.83 1.424a63.6 63.6 0 0 1-7.48 18.043zm-2.787 4.162 4.841 3.546a64.4 64.4 0 0 1-13.81 13.809l-3.546-4.841a58.3 58.3 0 0 0 12.515-12.514m-16.677 15.301 3.116 5.129a63.6 63.6 0 0 1-18.044 7.479l-1.423-5.83a57.7 57.7 0 0 0 16.351-6.778m-21.265 7.75.915 5.931c-3.184.487-6.445.74-9.765.74s-6.582-.253-9.766-.74l.916-5.93c2.884.441 5.84.67 8.85.67a58.4 58.4 0 0 0 8.85-.671m-22.614-.971-1.424 5.829a63.5 63.5 0 0 1-13.823-5.125l-6.074 1.418-1.363-5.843 8.208-1.916 1.953.995a57.5 57.5 0 0 0 12.523 4.642m-27.748-2.54 1.363 5.843-10.411 2.43C6.51 127.707.293 121.489 1.91 114.56l2.429-10.411 5.843 1.363-2.43 10.412c-.606 2.598 1.726 4.93 4.324 4.324zm-11.125-17.37L5.52 99.085l1.418-6.074a63.6 63.6 0 0 1-5.125-13.824l5.829-1.423a57.6 57.6 0 0 0 4.642 12.523l.994 1.953zM6.67 72.85l-5.93.915A64.5 64.5 0 0 1 0 64c0-3.32.253-6.582.74-9.766l5.931.916A58.5 58.5 0 0 0 6 64c0 3.01.229 5.966.67 8.85m.973-22.614-5.83-1.424a63.6 63.6 0 0 1 7.48-18.043l5.129 3.115a57.7 57.7 0 0 0-6.779 16.352m9.565-20.513-4.84-3.546a64.4 64.4 0 0 1 13.809-13.81l3.546 4.84a58.3 58.3 0 0 0-12.515 12.515Zm16.677-15.302-3.116-5.129a63.6 63.6 0 0 1 18.044-7.48l1.423 5.83a57.7 57.7 0 0 0-16.351 6.78Z"/><path d="M116 64c0 28.719-23.281 52-52 52-9.11 0-17.672-2.342-25.117-6.457a3.3 3.3 0 0 0-2.351-.341L13.4 114.599l5.397-23.13a3.3 3.3 0 0 0-.34-2.352C14.341 81.671 12 73.109 12 64c0-28.719 23.281-52 52-52s52 23.281 52 52"/></svg>
                    Signal
                </a>
                <a href="#" id="shareEmail" class="share-btn share-btn-email" title="Partager par email" aria-label="Partager par email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    Email
                </a>
                <a href="#" id="shareMastodon" class="share-btn share-btn-mastodon" target="_blank" rel="noopener" title="Partager sur Mastodon" aria-label="Partager sur Mastodon">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.668 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg>
                    Mastodon
                </a>
                <a href="#" id="shareBluesky" class="share-btn share-btn-bluesky" target="_blank" rel="noopener" title="Partager sur Bluesky" aria-label="Partager sur Bluesky">
                    <svg viewBox="0 0 600 530" fill="currentColor" aria-hidden="true"><path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/></svg>
                    Bluesky
                </a>
                <a href="#" id="shareLinkedIn" class="share-btn share-btn-linkedin" target="_blank" rel="noopener" title="Partager sur LinkedIn" aria-label="Partager sur LinkedIn">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    LinkedIn
                </a>
                <a href="#" id="shareWhatsApp" class="share-btn share-btn-whatsapp" target="_blank" rel="noopener" title="Partager sur WhatsApp" aria-label="Partager sur WhatsApp">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    WhatsApp
                </a>
                <a href="https://www.techpolicy.press/the-eus-fine-against-x-is-not-about-speech-or-censorship/" target="_blank" rel="noopener" class="share-btn share-btn-x" title="Twitter - 2006-2023" aria-label="Twitter - 2006-2023">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                    2006-2023
                </a>
            </div>
        </div>

        <!-- Publications popup -->
        <div class="publications-overlay" id="publicationsOverlay">
            <div class="publications-popup">
                <div class="publications-popup-header">
                    <div class="publications-popup-title">
                        <span class="theme-indicator" id="popupThemeIndicator"></span>
                        <span id="popupThemeTitle">Publications</span>
                    </div>
                    <button class="publications-popup-close" id="publicationsClose" aria-label="Fermer">&times;</button>
                </div>
                <div class="publications-popup-content" id="publicationsContent">
                    <div class="publications-loading">Chargement...</div>
                </div>
            </div>
        </div>

        <footer>
            <p>DonnÃ©es issues de la presse francophone sur Bluesky entre le 4 mars 2025 et le 31 dÃ©cembre 2025</p>
            <p><a href="https://revue-de-presse.org">revue-de-presse.org</a> Â· <a href="https://play.google.com/store/apps/details?id=org.revue_2_presse" target="_blank" rel="noopener">ðŸ“±&nbsp;Application Android</a></p>
            <p><a href="#" id="emailLink" aria-label="Envoyer un email Ã  contact+bonne-annee@revue-de-presse.org">contact+bonne-annee [chez] revue-de-presse [point] org</a></p>
            <p><a href="https://github.com/revue-de-presse/revuedepresse.github.io/" target="_blank" rel="noopener" title="Code source sur GitHub">Code source</a> Â· <span class="build-version">v{{BUILD_HASH}}</span></p>
            <p class="copyleft">ðŸ¦¬ <span id="copyleftYear"></span> Revue-de-presse.org â€” Copyleft, tous droits renversÃ©s</p>
        </footer>
    </div>

    <script>
        // Wait for D3 to load (deferred script)
        document.addEventListener('DOMContentLoaded', function() {
        // ===== SENTIMENT INDICATOR =====
        let sentimentData = {};
        let previousEmoji = 'ðŸ˜';

        async function loadSentimentData() {
            try {
                const response = await fetch('sentiment.json');
                if (response.ok) {
                    sentimentData = await response.json();
                    console.log(`Loaded sentiment for ${sentimentData.daily_sentiment?.length || 0} days`);
                }
            } catch (e) {
                console.warn('Could not load sentiment.json:', e);
            }
        }

        function updateSentimentIndicator(date) {
            const indicator = document.getElementById('sentimentIndicator');
            const emojiEl = document.getElementById('sentimentEmoji');
            const labelEl = document.getElementById('sentimentLabel');
            const fillEl = document.getElementById('sentimentFill');

            if (!indicator || !sentimentData.daily_sentiment) return;

            // Find sentiment for this date
            const daySentiment = sentimentData.daily_sentiment.find(d => d.date === date);

            if (!daySentiment) return;

            const { emoji, label, score } = daySentiment;

            // Animate emoji change
            if (emoji !== previousEmoji) {
                emojiEl.classList.add('changing');
                setTimeout(() => {
                    emojiEl.textContent = emoji;
                    emojiEl.classList.remove('changing');
                }, 200);
                previousEmoji = emoji;
            }

            // Update label
            const labelMap = {
                'very_negative': 'Tres negatif',
                'negative': 'Negatif',
                'neutral': 'Neutre',
                'positive': 'Positif',
                'very_positive': 'Tres positif'
            };
            labelEl.textContent = labelMap[label] || 'Neutre';

            // Update sentiment bar (score from -1 to 1, map to 0-100%)
            const fillPercent = ((score + 1) / 2) * 100;
            fillEl.style.width = `${fillPercent}%`;

            // Update data attribute for CSS styling
            indicator.setAttribute('data-sentiment', label);
        }

        // ===== WEB AUDIO API - Sonification dynamique =====
        let audioContext = null;
        let soundEnabled = false;
        let lastLeaderTheme = null;
        let lastScores = {};

        // Frequences associees aux themes (gamme pentatonique pour un son agreable)
        const themeFrequencies = {
            'Trump / USA': 261.63,        // C4
            'Ukraine / Russie': 293.66,   // D4
            'Gaza / Palestine': 329.63,   // E4
            'Climat / Environnement': 392.00, // G4
            'Extreme droite / RN': 415.30, // G#4
            'Executif / Gouvernement': 440.00, // A4
            'Parlement': 466.16,          // A#4
            'Gauche / NFP': 493.88,       // B4
            'Justice / Police': 523.25,   // C5
            'Social / Travail': 587.33,   // D5
            'Culture / Medias': 659.25,   // E5
            'Sante': 698.46,              // F5
            'Droits des femmes': 783.99,  // G5
            'Economie': 880.00,           // A5
            'Immigration': 987.77         // B5
        };

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Option 1: Simple tick sounds
        function playTick(volume = 0.02) {
            if (!audioContext || !soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 1200;
            oscillator.type = 'sine';

            const now = audioContext.currentTime;
            gainNode.gain.setValueAtTime(volume, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.02);

            oscillator.start(now);
            oscillator.stop(now + 0.02);
        }

        function playLeaderChange(newLeader) {
            if (!audioContext || !soundEnabled) return;

            // Two-tone ascending sound for leader change
            const now = audioContext.currentTime;

            [523.25, 659.25].forEach((freq, i) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = freq;
                oscillator.type = 'sine';

                const startTime = now + i * 0.08;
                gainNode.gain.setValueAtTime(0.12, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);

                oscillator.start(startTime);
                oscillator.stop(startTime + 0.15);
            });
        }

        function playProgressSound(chartData) {
            if (!soundEnabled || !chartData || chartData.length === 0) return;

            const leader = chartData[0];
            if (leader && leader.theme !== lastLeaderTheme) {
                playLeaderChange(leader.theme);
                lastLeaderTheme = leader.theme;
            } else {
                playTick();
            }
        }

        // Keep this for toggle sound confirmation
        function playChord(frequencies, duration = 0.3, volume = 0.08) {
            if (!audioContext || !soundEnabled) return;

            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    const now = audioContext.currentTime;
                    gainNode.gain.setValueAtTime(volume, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    oscillator.start(now);
                    oscillator.stop(now + duration);
                }, i * 30);
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundBtn');

            if (soundEnabled) {
                initAudio();
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Son';
                // Son de confirmation
                playChord([392, 523.25, 659.25], 0.3, 0.1);
            } else {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Son';
            }
        }

        // ===== CONFIGURATION DES THEMES (dynamique via topics.json) =====
        // Cette configuration sera mise Ã  jour dynamiquement lors du chargement
        let themeConfig = {};
        let topicsLoaded = false;

        // Charger les topics depuis topics.json
        async function loadTopicsConfig() {
            try {
                const response = await fetch('topics.json');
                if (response.ok) {
                    const topicsData = await response.json();
                    // Convertir topic_config au format attendu par le reste du code
                    for (const [themeName, config] of Object.entries(topicsData.topic_config)) {
                        themeConfig[themeName] = {
                            keywords: config.keywords || [],
                            color: config.color || '#999999'
                        };
                    }
                    topicsLoaded = true;
                    console.log(`Loaded ${Object.keys(themeConfig).length} dynamic topics`);
                    return true;
                }
            } catch (e) {
                console.warn('Could not load topics.json, using fallback themes');
            }
            // Fallback si topics.json n'existe pas
            themeConfig = {
                'Trump / USA': { keywords: ['trump', 'usa', 'americain'], color: '#c0392b' },
                'Climat': { keywords: ['climat', 'climatique', 'environnement'], color: '#27ae60' },
                'Gaza / Palestine': { keywords: ['gaza', 'palestine', 'israel'], color: '#006663' },
                'Justice': { keywords: ['justice', 'tribunal', 'police'], color: '#7a6855' },
                'Autres': { keywords: [], color: '#999999' }
            };
            return false;
        }

        // Fonction pour nettoyer le texte
        function sanitizeText(text) {
            if (!text) return '';
            return text
                .replace(/\\n/g, ' ')
                .replace(/\n/g, ' ')
                .replace(/\\r/g, ' ')
                .replace(/\r/g, ' ')
                .replace(/\\t/g, ' ')
                .replace(/\t/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/"/g, '')
                .replace(/\\/g, '')
                .replace(/\u00a0/g, ' ')
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/https?:\/\/[^\s]+/g, '')
                .trim();
        }

        // Normaliser le texte pour la recherche de mots-cles
        function normalizeText(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        // Calculate median of an array of numbers
        function calculateMedian(numbers) {
            if (numbers.length === 0) return 0;
            const sorted = [...numbers].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0
                ? sorted[mid]
                : Math.floor((sorted[mid - 1] + sorted[mid]) / 2);
        }

        // Truncate URL for display at median length with ellipsis, keeping href intact
        function truncateUrlForDisplay(url, maxLength) {
            if (!url || url.length <= maxLength) return url;
            return url.substring(0, maxLength) + 'â€¦';
        }

        // Generate engagement example from top article
        function generateEngagementExample(topArticle) {
            if (!topArticle) return '';

            const likes = topArticle.likes || 0;
            const reposts = topArticle.reposts || 0;
            const engagement = likes + (reposts * 2);

            // Clean and truncate text
            let text = sanitizeText(topArticle.text || '');
            if (text.length > 150) {
                text = text.substring(0, 147) + '...';
            }

            // Build profile URL and post URL from publication_id
            let profileUrl = '#';
            let postUrl = '#';
            if (topArticle.publication_id) {
                const match = topArticle.publication_id.match(/at:\/\/(did:plc:[^/]+)\/app\.bsky\.feed\.post\/(.+)/);
                if (match) {
                    profileUrl = `https://bsky.app/profile/${match[1]}`;
                    postUrl = `https://bsky.app/profile/${match[1]}/post/${match[2]}`;
                }
            }

            // Quote text with link to original post
            const quoteHtml = postUrl !== '#'
                ? `<a href="${postUrl}" target="_blank" rel="noopener" class="quote-text-link">Â« ${text} Â»</a>`
                : `Â« ${text} Â»`;

            // Avatar with link to profile
            const avatarUrl = topArticle.avatar_url || '';
            let avatarHtml = '';
            if (avatarUrl) {
                avatarHtml = profileUrl !== '#'
                    ? `<a href="${profileUrl}" target="_blank" rel="noopener" class="example-avatar-link"><img src="${avatarUrl}" alt="" class="example-avatar" loading="lazy" onerror="this.parentElement.style.display='none'"></a>`
                    : `<img src="${avatarUrl}" alt="" class="example-avatar" loading="lazy" onerror="this.style.display='none'">`;
            }

            // Screen name with link (dash outside)
            const screenNameHtml = profileUrl !== '#'
                ? `â€” ${avatarHtml}<a href="${profileUrl}" target="_blank" rel="noopener">${topArticle.screen_name}</a>`
                : `â€” ${avatarHtml}${topArticle.screen_name}`;

            return `
                <h4>Exemple\u00a0: l'une des publications parmi celles ayant suscitÃ© le plus d'engagement en 2025 sur une pÃ©riode de moins de 24 heures</h4>
                <blockquote>
                    ${quoteHtml}
                    <cite>${screenNameHtml}</cite>
                </blockquote>
                <p>
                    Cette publication a reÃ§u <strong>${likes.toLocaleString('fr-FR')} mentions Â«\u00a0j'aime\u00a0Â»</strong>
                    et <strong>${reposts.toLocaleString('fr-FR')} republications</strong>.
                </p>
                <div class="formula-box">
                    <p>
                        Le score d'engagement combine les interactions Bluesky.
                        Les republications comptent double car elles amplifient
                        la portÃ©e du contenu vers de nouveaux rÃ©seaux.
                    </p>
                    <code>
                        Engagement = Likes + (Reposts Ã— 2)<br>
                        Engagement = ${likes.toLocaleString('fr-FR')} + (${reposts.toLocaleString('fr-FR')} Ã— 2)<br>
                        Engagement = ${likes.toLocaleString('fr-FR')} + ${(reposts * 2).toLocaleString('fr-FR')}<br>
                        <strong>Engagement = ${engagement.toLocaleString('fr-FR')} points</strong>
                    </code>
                </div>
            `;
        }

        // Find top article by engagement across all data
        function findTopYearlyArticle(data) {
            let topArticle = null;
            let maxEngagement = 0;

            data.forEach(dayData => {
                if (dayData.articles) {
                    dayData.articles.forEach(article => {
                        const engagement = (article.likes || 0) + (article.reposts || 0) * 2;
                        if (engagement > maxEngagement) {
                            maxEngagement = engagement;
                            topArticle = article;
                        }
                    });
                }
            });

            return topArticle;
        }

        // Obtenir le numero de semaine ISO
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Variables globales
        let allData = [];
        let currentIndex = 0;
        let isPlaying = false;
        let animationInterval;
        let cumulativeScores = {};
        let speed = 1200; // 1x at slider center (500)
        let isDragging = false;
        let animationMode = 'daily'; // 'cumulative' or 'daily'
        let scaleMode = 'linear'; // 'linear' or 'log'

        // Initialiser les scores
        Object.keys(themeConfig).forEach(theme => {
            cumulativeScores[theme] = 0;
        });

        // Dimensions du graphique - responsive
        const barHeight = 42;  // Increased for 2-line labels
        const barPadding = 4;
        const n = 10;
        const height = n * (barHeight + barPadding);

        // Fonction pour calculer les dimensions selon la largeur du viewport
        function getChartDimensions() {
            const containerWidth = document.querySelector('.chart-container').clientWidth;
            const viewportWidth = window.innerWidth;

            // Marges adaptatives selon la taille d'ecran
            // Breakpoints bases sur les appareils reels:
            // - iPhone SE/5: 320px
            // - iPhone 6/7/8/X/11/12/13/14: 375-390px
            // - iPhone Plus/Max: 414-428px
            // - Samsung Galaxy S: 360px
            // - Samsung Galaxy Note: 412px
            // - iPad Mini: 768px
            // - iPad: 810px
            // - iPad Pro: 1024px
            // - Laptop: 1280-1440px
            // - Desktop: 1920px+

            let margin, labelWidth;
            if (viewportWidth <= 320) {
                // iPhone SE, iPhone 5, petits mobiles
                margin = { top: 10, right: 45, bottom: 10, left: 110 };
                labelWidth = 105;
            } else if (viewportWidth <= 375) {
                // iPhone 6/7/8, iPhone X/11/12/13/14, Samsung Galaxy S
                margin = { top: 10, right: 50, bottom: 10, left: 120 };
                labelWidth = 115;
            } else if (viewportWidth <= 414) {
                // iPhone Plus, iPhone Max, Samsung Galaxy Note
                margin = { top: 10, right: 55, bottom: 10, left: 130 };
                labelWidth = 125;
            } else if (viewportWidth <= 480) {
                // Grands mobiles, petites tablettes portrait
                margin = { top: 10, right: 60, bottom: 10, left: 140 };
                labelWidth = 135;
            } else if (viewportWidth <= 600) {
                // Tablettes portrait petites
                margin = { top: 10, right: 70, bottom: 10, left: 160 };
                labelWidth = 155;
            } else if (viewportWidth <= 768) {
                // iPad Mini, tablettes portrait
                margin = { top: 10, right: 75, bottom: 10, left: 180 };
                labelWidth = 175;
            } else if (viewportWidth <= 834) {
                // iPad portrait
                margin = { top: 10, right: 80, bottom: 10, left: 195 };
                labelWidth = 190;
            } else if (viewportWidth <= 1024) {
                // iPad Pro portrait, tablettes paysage
                margin = { top: 10, right: 90, bottom: 10, left: 210 };
                labelWidth = 205;
            } else if (viewportWidth <= 1280) {
                // Petits laptops, iPad Pro paysage
                margin = { top: 10, right: 95, bottom: 10, left: 220 };
                labelWidth = 215;
            } else if (viewportWidth <= 1440) {
                // Laptops standards
                margin = { top: 10, right: 100, bottom: 10, left: 230 };
                labelWidth = 225;
            } else if (viewportWidth <= 1920) {
                // Desktop Full HD
                margin = { top: 10, right: 105, bottom: 10, left: 240 };
                labelWidth = 235;
            } else {
                // Large desktop, 4K
                margin = { top: 10, right: 110, bottom: 10, left: 250 };
                labelWidth = 245;
            }

            // Largeur disponible
            const containerPadding = viewportWidth <= 480 ? 20 : (viewportWidth <= 768 ? 30 : 80);
            const availableWidth = Math.min(containerWidth - containerPadding, 1200);
            const width = availableWidth - margin.left - margin.right;

            return { margin, width: Math.max(width, 150), labelWidth };
        }

        let { margin, width, labelWidth } = getChartDimensions();

        // Fonction pour decouper les labels en lignes selon la largeur disponible
        function wrapLabel(text, maxWidth) {
            const viewportWidth = window.innerWidth;
            // Estimation: ~7px par caractere en moyenne
            const charWidth = viewportWidth <= 480 ? 5.5 : (viewportWidth <= 768 ? 6 : 6.5);
            const maxChars = Math.floor(maxWidth / charWidth);

            if (text.length <= maxChars) return [text];

            // Split by " / " first (topic name separator)
            const parts = text.split(' / ');
            if (parts.length > 1) {
                // Return first 2 parts max for readability
                return parts.slice(0, 2);
            }

            // Otherwise split by spaces
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (const word of words) {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                if (testLine.length <= maxChars) {
                    currentLine = testLine;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) lines.push(currentLine);

            // Limit to 2 lines max
            return lines.slice(0, 2);
        }

        // Apply wrapped label to SVG text element with tspans
        function applyWrappedLabel(textElement, theme, maxWidth, barHeight) {
            const lines = wrapLabel(theme, maxWidth);
            textElement.selectAll('tspan').remove();

            const lineHeight = 12; // pixels per line
            const totalHeight = lines.length * lineHeight;
            const startY = (barHeight - totalHeight) / 2 + lineHeight - 2;

            lines.forEach((line, i) => {
                textElement.append('tspan')
                    .attr('x', -8)
                    .attr('dy', i === 0 ? startY : lineHeight)
                    .text(line);
            });
        }

        // Creer le SVG
        const svgElement = d3.select('#chart');
        const svg = svgElement
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Echelles
        function createXScale(mode, rangeWidth) {
            if (mode === 'log') {
                return d3.scaleLog().range([0, rangeWidth]).clamp(true);
            }
            return d3.scaleLinear().range([0, rangeWidth]);
        }
        let x = createXScale(scaleMode, width);
        const y = d3.scaleBand().range([0, n * (barHeight + barPadding)]).padding(0.1);

        // Redimensionnement responsive
        function resizeChart() {
            const dims = getChartDimensions();
            margin = dims.margin;
            width = dims.width;
            labelWidth = dims.labelWidth;

            svgElement
                .attr('width', width + margin.left + margin.right);

            svg.attr('transform', `translate(${margin.left},${margin.top})`);

            x.range([0, width]);

            // Mettre a jour les barres existantes
            if (allData.length > 0 && currentIndex >= 0) {
                updateChart(allData[currentIndex], false);
            }
        }

        // Debounce pour eviter trop d'appels
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeChart, 150);
        });

        // Fonction pour classifier un article
        function classifyArticle(text) {
            const lowerText = normalizeText(text);
            const matches = [];

            for (const [theme, config] of Object.entries(themeConfig)) {
                for (const keyword of config.keywords) {
                    if (lowerText.includes(keyword)) {
                        matches.push(theme);
                        break;
                    }
                }
            }

            return matches.length > 0 ? matches : ['Autres'];
        }

        // Construire la frise chronologique
        // Build a set of dates that have data for calendar highlighting
        let datesWithData = new Set();

        function buildTimeline() {
            if (allData.length === 0) return;

            // Build set of dates with data
            datesWithData = new Set();
            allData.forEach(d => {
                datesWithData.add(d.date.split('T')[0]);
            });

            const months = ['Jan', 'FÃ©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'AoÃ»', 'Sep', 'Oct', 'Nov', 'DÃ©c'];
            const monthsFull = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
            const monthsContainer = document.getElementById('timelineMonths');
            const weeksContainer = document.getElementById('timelineWeeks');

            const firstDate = new Date(allData[0].date);
            const lastDate = new Date(allData[allData.length - 1].date);
            const startMonth = firstDate.getMonth();
            const endMonth = lastDate.getMonth();
            const year = firstDate.getFullYear();

            monthsContainer.innerHTML = '';
            for (let m = startMonth; m <= endMonth; m++) {
                const span = document.createElement('span');
                span.textContent = months[m];
                span.dataset.month = m;
                span.dataset.year = year;
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMonthCalendar(span, m, year, monthsFull[m]);
                });
                monthsContainer.appendChild(span);
            }

            const weeks = new Set();
            allData.forEach(d => {
                const date = new Date(d.date);
                weeks.add(getWeekNumber(date));
            });
            const weekNumbers = Array.from(weeks).sort((a, b) => a - b);

            weeksContainer.innerHTML = '';
            const step = Math.ceil(weekNumbers.length / 20);
            weekNumbers.forEach((w, i) => {
                if (i % step === 0 || i === weekNumbers.length - 1) {
                    const span = document.createElement('span');
                    span.textContent = `S${w}`;
                    span.dataset.week = w;
                    weeksContainer.appendChild(span);
                }
            });

            const timeline = document.getElementById('timeline');
            const tooltip = document.getElementById('timelineTooltip');

            timeline.addEventListener('click', handleTimelineClick);
            timeline.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleTimelineClick(e);
            });
            timeline.addEventListener('mousemove', (e) => {
                updateTooltip(e);
                if (isDragging) {
                    handleTimelineClick(e);
                }
            });
            timeline.addEventListener('mouseup', () => isDragging = false);
            timeline.addEventListener('mouseleave', () => {
                isDragging = false;
                tooltip.style.opacity = '0';
            });
        }

        // Month calendar functions
        let activeCalendar = null;

        function toggleMonthCalendar(monthSpan, month, year, monthName) {
            // Close any existing calendar
            closeAllCalendars();

            // Create calendar if not already showing for this month
            if (activeCalendar && activeCalendar.dataset.month === String(month)) {
                activeCalendar = null;
                return;
            }

            const calendar = document.createElement('div');
            calendar.className = 'month-calendar visible';
            calendar.dataset.month = month;

            // Header
            const header = document.createElement('div');
            header.className = 'month-calendar-header';
            header.textContent = `${monthName} ${year}`;
            calendar.appendChild(header);

            // Weekdays
            const weekdays = document.createElement('div');
            weekdays.className = 'month-calendar-weekdays';
            ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(day => {
                const span = document.createElement('span');
                span.textContent = day;
                weekdays.appendChild(span);
            });
            calendar.appendChild(weekdays);

            // Days grid
            const daysContainer = document.createElement('div');
            daysContainer.className = 'month-calendar-days';

            // Get first day of month (0 = Sunday, convert to Monday-first)
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6; // Sunday becomes 6

            // Days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty cells for days before start
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('span');
                empty.className = 'month-calendar-day empty';
                daysContainer.appendChild(empty);
            }

            // Day cells
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const hasData = datesWithData.has(dateStr);

                if (hasData) {
                    const dayEl = document.createElement('a');
                    dayEl.className = 'month-calendar-day has-data';
                    dayEl.textContent = d;
                    dayEl.href = `https://revue-de-presse.org/${dateStr}`;
                    dayEl.target = '_blank';
                    dayEl.rel = 'noopener';
                    dayEl.title = `Voir le ${dateStr} sur revue-de-presse.org`;
                    daysContainer.appendChild(dayEl);
                } else {
                    const dayEl = document.createElement('span');
                    dayEl.className = 'month-calendar-day';
                    dayEl.textContent = d;
                    daysContainer.appendChild(dayEl);
                }
            }

            calendar.appendChild(daysContainer);
            monthSpan.appendChild(calendar);
            activeCalendar = calendar;

            // Prevent calendar clicks from propagating
            calendar.addEventListener('click', (e) => e.stopPropagation());
        }

        function closeAllCalendars() {
            document.querySelectorAll('.month-calendar').forEach(cal => cal.remove());
            activeCalendar = null;
        }

        // Close calendar when clicking outside
        document.addEventListener('click', closeAllCalendars);

        function updateTooltip(e) {
            const timeline = document.getElementById('timeline');
            const tooltip = document.getElementById('timelineTooltip');
            const rect = timeline.getBoundingClientRect();
            const xPos = e.clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, xPos / rect.width));
            const index = Math.floor(percentage * (allData.length - 1));

            if (allData[index]) {
                const date = new Date(allData[index].date);
                const weekNum = getWeekNumber(date);
                const formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short'
                });
                tooltip.textContent = `${formattedDate} (S${weekNum})`;
                tooltip.style.left = `${xPos}px`;
                tooltip.style.opacity = '1';
            }
        }

        function handleTimelineClick(e) {
            const timeline = document.getElementById('timeline');
            const rect = timeline.getBoundingClientRect();
            const xPos = e.clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, xPos / rect.width));
            const targetIndex = Math.floor(percentage * (allData.length - 1));

            navigateToIndex(targetIndex);
        }

        function navigateToIndex(targetIndex) {
            pause();

            Object.keys(cumulativeScores).forEach(theme => {
                cumulativeScores[theme] = 0;
            });

            for (let i = 0; i <= targetIndex; i++) {
                allData[i].articles.forEach(article => {
                    const engagement = (article.likes || 0) + (article.reposts || 0) * 2;
                    const themes = classifyArticle(article.text);
                    themes.forEach(theme => {
                        if (cumulativeScores[theme] !== undefined) {
                            cumulativeScores[theme] += engagement;
                        }
                    });
                });
            }

            currentIndex = targetIndex;
            updateChart(allData[currentIndex], false);
            updateTimelineUI();
        }

        function updateTimelineUI() {
            const progress = ((currentIndex + 1) / allData.length) * 100;
            document.getElementById('timelineProgress').style.width = `${progress}%`;
            document.getElementById('timelineMarker').style.left = `${progress}%`;

            if (allData[currentIndex]) {
                const date = new Date(allData[currentIndex].date);
                const weekNum = getWeekNumber(date);
                document.getElementById('weekDisplay').textContent = `Semaine ${weekNum}`;

                document.querySelectorAll('.timeline-weeks span').forEach(span => {
                    span.classList.remove('current');
                    if (parseInt(span.dataset.week) === weekNum) {
                        span.classList.add('current');
                    }
                });
            }
        }

        // Charger les donnees
        async function loadData() {
            // Charger d'abord les topics dynamiques et sentiment data
            await Promise.all([
                loadTopicsConfig(),
                loadSentimentData()
            ]);

            // Reinitialiser cumulativeScores avec les nouveaux themes
            cumulativeScores = {};
            Object.keys(themeConfig).forEach(theme => {
                cumulativeScores[theme] = 0;
            });

            const response = await fetch('data-combined.json');
            const data = await response.json();

            data.sort((a, b) => new Date(a.date) - new Date(b.date));

            const groupedByDate = {};
            data.forEach(article => {
                const dateKey = article.date.split('T')[0];
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(article);
            });

            allData = Object.entries(groupedByDate).map(([date, articles]) => ({
                date,
                articles
            }));

            console.log(`Loaded ${allData.length} days of data`);
            buildTimeline();
            buildLegend();

            // Generate engagement example from top yearly article
            const topYearlyArticle = findTopYearlyArticle(allData);
            if (topYearlyArticle) {
                const exampleEl = document.getElementById('engagementExample');
                if (exampleEl) {
                    exampleEl.innerHTML = generateEngagementExample(topYearlyArticle);
                }
            }

            // Render first day immediately
            if (allData.length > 0) {
                currentIndex = 0;
                recalculateScoresUpTo(0);
                updateChart(allData[0], false);
                updateTimelineUI();
            }

            // Auto-start animation after a short delay
            setTimeout(() => {
                play();
            }, 1000);
        }

        // Build map of theme -> bsky URLs
        function buildThemeLinksMap() {
            const themeLinks = {};
            Object.keys(themeConfig).forEach(theme => {
                themeLinks[theme] = [];
            });

            // Iterate through all loaded data
            allData.forEach(dayData => {
                dayData.articles.forEach(article => {
                    if (!article.publication_id) return;

                    // Extract bsky URL from publication_id
                    const match = article.publication_id.match(/at:\/\/(did:plc:[^/]+)\/app\.bsky\.feed\.post\/(.+)/);
                    if (!match) return;

                    const bskyUrl = `https://bsky.app/profile/${match[1]}/post/${match[2]}`;
                    const themes = classifyArticle(article.text);

                    themes.forEach(theme => {
                        if (themeLinks[theme] && !themeLinks[theme].includes(bskyUrl)) {
                            themeLinks[theme].push(bskyUrl);
                        }
                    });
                });
            });

            return themeLinks;
        }

        // Capitalize proper nouns (countries, cities, companies, people)
        function capitalizeProperNouns(keyword) {
            // List of proper nouns that should be capitalized
            const properNouns = new Set([
                // Countries
                'russie', 'russe', 'russes', 'ukraine', 'ukrainien', 'ukrainienne', 'ukrainiens',
                'france', 'franÃ§ais', 'franÃ§aise', 'franÃ§aises', 'franÃ§aises',
                'allemagne', 'allemand', 'allemande', 'allemands',
                'italie', 'italien', 'italienne', 'italiens',
                'espagne', 'espagnol', 'espagnole', 'espagnols',
                'Ã©tats-unis', 'etats-unis', 'amÃ©ricain', 'amÃ©ricaine', 'amÃ©ricains',
                'chine', 'chinois', 'chinoise', 'iran', 'iranien', 'iranienne',
                'israÃ«l', 'israel', 'israÃ©lien', 'israÃ©lienne',
                'palestine', 'palestinien', 'palestinienne', 'palestiniens',
                'syrie', 'syrien', 'syrienne', 'syriens',
                'liban', 'libanais', 'libanaise',
                'gaza', 'cisjordanie', 'jÃ©rusalem', 'jerusalem',
                'europe', 'europÃ©en', 'europÃ©enne', 'europÃ©ens',
                'afrique', 'africain', 'africaine', 'africains',
                'asie', 'asiatique', 'asiatiques',
                'brÃ©sil', 'bresil', 'brÃ©silien', 'brÃ©silienne',
                'mexique', 'mexicain', 'mexicaine',
                'canada', 'canadien', 'canadienne',
                'japon', 'japonais', 'japonaise',
                'corÃ©e', 'coree', 'corÃ©en', 'corÃ©enne',
                'inde', 'indien', 'indienne', 'indiens',
                'turquie', 'turc', 'turque', 'turcs',
                'grÃ¨ce', 'grece', 'grec', 'grecque',
                'pologne', 'polonais', 'polonaise',
                'hongrie', 'hongrois', 'hongroise',
                'suÃ¨de', 'suede', 'suÃ©dois', 'suÃ©doise',
                'norvÃ¨ge', 'norvege', 'norvÃ©gien', 'norvÃ©gienne',
                'finlande', 'finlandais', 'finlandaise',
                'danemark', 'danois', 'danoise',
                'pays-bas', 'nÃ©erlandais', 'nÃ©erlandaise', 'hollandais', 'hollandaise',
                'belgique', 'belge', 'belges',
                'suisse', 'helvÃ©tique',
                'autriche', 'autrichien', 'autrichienne',
                'portugal', 'portugais', 'portugaise',
                'royaume-uni', 'britannique', 'britanniques', 'anglais', 'anglaise',
                'ecosse', 'Ã©cossais', 'Ã©cossaise', 'irlande', 'irlandais', 'irlandaise',
                'australie', 'australien', 'australienne',
                // Cities
                'paris', 'parisien', 'parisienne', 'parisiens',
                'lyon', 'lyonnais', 'lyonnaise',
                'marseille', 'marseillais', 'marseillaise',
                'bordeaux', 'bordelais', 'bordelaise',
                'toulouse', 'toulousain', 'toulousaine',
                'nice', 'niÃ§ois', 'niÃ§oise',
                'strasbourg', 'strasbourgeois', 'strasbourgeoise',
                'nantes', 'nantais', 'nantaise',
                'montpellier', 'montpelliÃ©rain', 'montpelliÃ©raine',
                'lille', 'lillois', 'lilloise',
                'rennes', 'rennais', 'rennaise',
                'londres', 'londonien', 'londonienne',
                'berlin', 'berlinois', 'berlinoise',
                'rome', 'romain', 'romaine',
                'madrid', 'madrilÃ¨ne',
                'bruxelles', 'bruxellois', 'bruxelloise',
                'washington', 'new york', 'new-york',
                'moscou', 'moscovite',
                'kiev', 'kyiv',
                'pÃ©kin', 'pekin', 'shanghai', 'hong kong', 'hong-kong',
                'tokyo', 'tÃ©hÃ©ran', 'teheran',
                // Companies
                'bollorÃ©', 'bollore', 'vivendi', 'canal+', 'canal +',
                'tf1', 'france tÃ©lÃ©visions', 'france televisions',
                'le monde', 'libÃ©ration', 'liberation', 'le figaro',
                'bfm', 'bfmtv', 'cnews', 'lci',
                'google', 'meta', 'facebook', 'twitter', 'x',
                'amazon', 'apple', 'microsoft', 'tesla', 'spacex',
                'openai', 'anthropic', 'nvidia',
                'total', 'totalenergies', 'edf', 'engie', 'sncf', 'ratp',
                'renault', 'peugeot', 'citroÃ«n', 'citroen', 'stellantis',
                'airbus', 'boeing', 'dassault', 'safran', 'thales',
                'lvmh', 'kering', 'hermÃ¨s', 'hermes', 'chanel', 'dior',
                'carrefour', 'auchan', 'leclerc', 'casino', 'intermarchÃ©',
                'bnp', 'bnp paribas', 'sociÃ©tÃ© gÃ©nÃ©rale', 'crÃ©dit agricole',
                'axa', 'allianz', 'groupama',
                'orange', 'sfr', 'bouygues', 'free', 'iliad',
                'veolia', 'suez', 'vinci', 'bouygues', 'eiffage',
                // People (common in news)
                'macron', 'le pen', 'mÃ©lenchon', 'melenchon', 'bardella',
                'trump', 'biden', 'harris', 'obama', 'clinton',
                'poutine', 'zelensky', 'zelenskyy',
                'netanyahou', 'netanyahu', 'xi jinping', 'modi',
                'scholz', 'sunak', 'starmer',
                'musk', 'bezos', 'zuckerberg', 'cook', 'gates',
                'bolsonaro', 'lula',
                // Organizations
                'otan', 'nato', 'onu', 'unesco', 'unicef',
                'ue', 'union europÃ©enne', 'commission europÃ©enne', 'parlement europÃ©en',
                'fmi', 'banque mondiale', 'bce', 'fed',
                'hamas', 'hezbollah', 'daech', 'isis',
                'wagner', 'kremlin', 'maison blanche', 'pentagone', 'cia', 'fbi', 'nsa',
                'Ã©lysÃ©e', 'elysee', 'matignon', 'quai d\'orsay', 'bercy',
                'sÃ©nat', 'senat', 'assemblÃ©e nationale'
            ]);

            const lowerKeyword = keyword.toLowerCase();
            if (properNouns.has(lowerKeyword)) {
                // Capitalize first letter of each word
                return keyword.split(/(\s+|-)/).map(word => {
                    if (word.match(/^\s+$/) || word === '-') return word;
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join('');
            }
            return keyword;
        }

        // Construire la legende avec mots-clÃ©s dÃ©pliables
        function buildLegend() {
            const legendEl = document.getElementById('legend');
            if (!legendEl) return;

            // Build theme links map
            const themeLinks = buildThemeLinksMap();

            // Sort themes by link count (descending), with 'Autres' excluded
            const sortedThemes = Object.entries(themeConfig)
                .filter(([theme]) => theme !== 'Autres')
                .sort((a, b) => (themeLinks[b[0]]?.length || 0) - (themeLinks[a[0]]?.length || 0));

            let html = `
                <details class="keywords-foldable" id="legendKeywordsFoldable">
                    <summary title="Afficher ou masquer les mots-clÃ©s par thÃ¨me" aria-label="Afficher ou masquer les mots-clÃ©s par thÃ¨me">
                        <span class="toggle-label">Mots-clÃ©s par thÃ¨me</span>
                        <span class="toggle-indicator">Afficher â–¼</span>
                    </summary>
                    <div class="keywords-content">
            `;

            sortedThemes.forEach(([theme, config]) => {
                const keywords = config.keywords || [];
                const links = themeLinks[theme] || [];
                if (keywords.length > 0) {
                    const linksJson = JSON.stringify(links);
                    const escapedJson = linksJson.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const escapedTheme = theme.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const formattedKeywords = keywords.map(kw => capitalizeProperNouns(kw)).join(', ');
                    html += `
                        <div class="keyword-group" data-theme="${escapedTheme}" data-color="${config.color}">
                            <h4 style="border-left: 3px solid ${config.color}; padding-left: 8px;">${theme}</h4>
                            <p class="keyword-list">${formattedKeywords}</p>
                            <div class="keyword-group-footer">
                                <a href="#" class="link-count-btn" data-theme="${escapedTheme}" title="Voir les publications">${links.length} lien${links.length > 1 ? 's' : ''}</a>
                                <a href="#" class="json-copy-link" data-links="${escapedJson}" title="Copier les liens JSON">["json"]</a>
                            </div>
                        </div>
                    `;
                }
            });

            html += `
                    </div>
                </details>
            `;

            legendEl.innerHTML = html;
        }

        // Mettre a jour le graphique
        function updateChart(dayData, transition = true) {
            const dateObj = new Date(dayData.date);
            const formattedDate = dateObj.toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            document.getElementById('currentDate').textContent = formattedDate;

            let topArticle = null;
            let maxEngagement = 0;

            dayData.articles.forEach(article => {
                const engagement = (article.likes || 0) + (article.reposts || 0) * 2;

                if (engagement > maxEngagement) {
                    maxEngagement = engagement;
                    topArticle = article;
                }
            });

            if (topArticle) {
                const headlineEl = document.getElementById('headlineText');
                const articleText = sanitizeText(topArticle.text);

                // Convert at:// URI to Bluesky URL
                let bskyUrl = null;
                if (topArticle.publication_id) {
                    // Format: at://did:plc:xxx/app.bsky.feed.post/postId
                    const match = topArticle.publication_id.match(/at:\/\/(did:plc:[^/]+)\/app\.bsky\.feed\.post\/(.+)/);
                    if (match) {
                        const did = match[1];
                        const postId = match[2];
                        bskyUrl = `https://bsky.app/profile/${did}/post/${postId}`;
                    }
                }

                if (bskyUrl) {
                    headlineEl.innerHTML = `<a href="${bskyUrl}" target="_blank" rel="noopener" class="headline-link">${articleText}</a>`;
                } else {
                    headlineEl.textContent = articleText;
                }

                const outletLogo = document.getElementById('outletLogo');
                const outletLogoLink = document.getElementById('outletLogoLink');
                const outletName = document.getElementById('outletName');
                outletName.textContent = topArticle.screen_name;

                // Extract DID from publication_id to create Bluesky profile link
                let profileUrl = null;
                if (topArticle.publication_id) {
                    const didMatch = topArticle.publication_id.match(/at:\/\/(did:plc:[^/]+)/);
                    if (didMatch) {
                        profileUrl = `https://bsky.app/profile/${didMatch[1]}`;
                    }
                }

                if (profileUrl) {
                    outletName.href = profileUrl;
                    outletName.style.pointerEvents = 'auto';
                    outletLogoLink.href = profileUrl;
                } else {
                    outletName.href = '#';
                    outletName.style.pointerEvents = 'none';
                    outletLogoLink.href = '#';
                }

                if (topArticle.avatar_url) {
                    outletLogo.src = topArticle.avatar_url;
                    outletLogo.alt = topArticle.screen_name;
                    outletLogoLink.classList.add('visible');
                } else {
                    outletLogoLink.classList.remove('visible');
                }
            }

            // Choose scores based on animation mode
            const scores = animationMode === 'daily'
                ? calculateDailyScores(dayData)
                : cumulativeScores;

            const chartData = Object.entries(scores)
                .map(([theme, score]) => ({
                    theme,
                    score,
                    color: themeConfig[theme]?.color || '#999'
                }))
                .filter(d => d.theme !== 'Autres' && d.score > 0) // Exclude Autres and zero-score themes
                .sort((a, b) => b.score - a.score)
                .slice(0, n);

            // Audio feedback
            if (transition) {
                playProgressSound(chartData);
            }

            const maxScore = d3.max(chartData, d => d.score) || 1;
            // Recreate x scale with current mode (log scale needs min > 0)
            x = createXScale(scaleMode, width);
            if (scaleMode === 'log') {
                x.domain([1, Math.max(maxScore * 1.1, 10)]);
            } else {
                x.domain([0, Math.max(maxScore * 1.1, 10)]);
            }
            y.domain(chartData.map(d => d.theme));

            const bars = svg.selectAll('.bar')
                .data(chartData, d => d.theme);

            const duration = transition ? speed * 0.8 : 0;

            // ENTER: New bars fade in from left with opacity animation
            const barsEnter = bars.enter()
                .append('g')
                .attr('class', d => d.theme === 'Autres' ? 'bar autres-bar' : 'bar')
                .attr('opacity', 0)
                .attr('transform', d => `translate(-30, ${y(d.theme)})`);

            barsEnter.append('rect')
                .attr('height', barHeight)
                .attr('fill', d => d.color)
                .attr('rx', 3)
                .attr('width', 0);

            barsEnter.append('text')
                .attr('class', 'bar-label')
                .attr('x', -8)
                .attr('text-anchor', 'end')
                .attr('opacity', 0);

            barsEnter.append('text')
                .attr('class', 'bar-value')
                .attr('dy', barHeight / 2 + 4)
                .attr('opacity', 0);

            // Animate entering bars
            barsEnter.transition()
                .duration(duration * 0.5)
                .attr('opacity', d => d.theme === 'Autres' ? 0.6 : 1)
                .attr('transform', d => `translate(0, ${y(d.theme)})`);

            barsEnter.select('.bar-label')
                .transition()
                .delay(duration * 0.3)
                .duration(duration * 0.5)
                .attr('opacity', 1);

            barsEnter.select('.bar-value')
                .transition()
                .delay(duration * 0.3)
                .duration(duration * 0.5)
                .attr('opacity', 1);

            // UPDATE: Smooth position and size changes
            const barsUpdate = bars.merge(barsEnter);

            barsUpdate.transition()
                .duration(duration)
                .attr('opacity', d => d.theme === 'Autres' ? 0.6 : 1)
                .attr('transform', d => `translate(0, ${y(d.theme)})`);

            barsUpdate.select('rect')
                .transition()
                .duration(duration)
                .attr('width', d => d.score > 0 ? x(d.score) : 0)
                .attr('fill', d => d.color)
                .attr('opacity', d => d.score > 0 ? 1 : 0);

            barsUpdate.select('.bar-label')
                .each(function(d) {
                    applyWrappedLabel(d3.select(this), d.theme, labelWidth, barHeight);
                })
                .attr('opacity', d => d.score > 0 ? 1 : 0);

            barsUpdate.select('.bar-value')
                .transition()
                .duration(duration)
                .attr('x', d => x(d.score) + 8)
                .attr('opacity', d => d.score > 0 ? 1 : 0)
                .tween('text', function(d) {
                    const node = this;
                    const i = d3.interpolateNumber(parseInt(node.textContent.replace(/\D/g, '')) || 0, d.score);
                    return function(t) {
                        node.textContent = Math.round(i(t)).toLocaleString('fr-FR');
                    };
                });

            // EXIT: Fade out and slide left
            bars.exit()
                .transition()
                .duration(duration * 0.5)
                .attr('opacity', 0)
                .attr('transform', d => `translate(-30, ${y(d.theme) || 0})`)
                .remove();

            bars.exit().select('.bar-label')
                .transition()
                .duration(duration * 0.3)
                .attr('opacity', 0);

            bars.exit().select('.bar-value')
                .transition()
                .duration(duration * 0.3)
                .attr('opacity', 0);

            const totalArticles = allData.slice(0, currentIndex + 1)
                .reduce((sum, d) => sum + d.articles.length, 0);
            const totalEngagement = Object.values(cumulativeScores)
                .reduce((sum, score) => sum + score, 0);

            document.getElementById('totalArticles').textContent = totalArticles.toLocaleString('fr-FR');
            document.getElementById('totalEngagement').textContent = totalEngagement.toLocaleString('fr-FR');
            const leaderTheme = chartData[0]?.theme || '-';
            document.getElementById('leadingTheme').textContent = leaderTheme;
            document.getElementById('daysProcessed').textContent = currentIndex + 1;

            updateTimelineUI();

            // Update sentiment indicator
            const dateStr = dayData.date.split('T')[0];
            updateSentimentIndicator(dateStr);

            // Apply colorblind patterns if enabled
            if (patternsEnabled) {
                setTimeout(applyPatterns, duration + 50);
            }
        }

        // Get effective speed (slower in daily mode for better readability)
        function getEffectiveSpeed() {
            return animationMode === 'daily' ? speed * 2 : speed;
        }

        function play() {
            if (isPlaying) return;
            isPlaying = true;

            // Initialiser l'audio au premier play si le son est active
            if (soundEnabled) {
                initAudio();
            }

            const effectiveSpeed = getEffectiveSpeed();

            animationInterval = setInterval(() => {
                if (currentIndex >= allData.length - 1) {
                    pause();
                    return;
                }
                currentIndex++;

                allData[currentIndex].articles.forEach(article => {
                    const engagement = (article.likes || 0) + (article.reposts || 0) * 2;
                    const themes = classifyArticle(article.text);
                    themes.forEach(theme => {
                        if (cumulativeScores[theme] !== undefined) {
                            cumulativeScores[theme] += engagement;
                        }
                    });
                });

                updateChart(allData[currentIndex]);
            }, effectiveSpeed);
        }

        function pause() {
            isPlaying = false;
            clearInterval(animationInterval);
        }

        function reset() {
            pause();
            currentIndex = 0;
            Object.keys(cumulativeScores).forEach(theme => {
                cumulativeScores[theme] = 0;
            });
            lastLeaderTheme = null;
            lastScores = {};
            svg.selectAll('.bar').remove();
            document.getElementById('currentDate').textContent = 'Mars 2025';
            document.getElementById('weekDisplay').textContent = 'Semaine 10';
            document.getElementById('timelineProgress').style.width = '0%';
            document.getElementById('timelineMarker').style.left = '0%';
            document.getElementById('totalArticles').textContent = '0';
            document.getElementById('totalEngagement').textContent = '0';
            document.getElementById('leadingTheme').textContent = '-';
            document.getElementById('daysProcessed').textContent = '0';
            document.getElementById('headlineText').innerHTML = '<button class="btn-start-inline" id="startBtnInline" title="Lancer l\'animation"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5,3 19,12 5,21"/></svg> Lancer l\'animation</button>';
            document.getElementById('startBtnInline').addEventListener('click', play);
            const outletNameEl = document.getElementById('outletName');
            outletNameEl.textContent = '';
            outletNameEl.href = '#';
            outletNameEl.style.pointerEvents = 'none';
            const outletLogoLinkEl = document.getElementById('outletLogoLink');
            outletLogoLinkEl.classList.remove('visible');
            outletLogoLinkEl.href = '#';

            document.querySelectorAll('.timeline-weeks span').forEach(span => {
                span.classList.remove('current');
            });
        }

        // Event listeners
        document.getElementById('playBtn').addEventListener('click', play);
        document.getElementById('pauseBtn').addEventListener('click', pause);
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('soundBtn').addEventListener('click', toggleSound);
        document.getElementById('helpBtn').addEventListener('click', toggleHelpModal);

        // Date display click - navigate to revue-de-presse.org for that day
        document.getElementById('currentDate').addEventListener('click', () => {
            if (allData.length > 0 && currentIndex >= 0 && allData[currentIndex]) {
                const dateStr = allData[currentIndex].date.split('T')[0]; // YYYY-MM-DD
                const url = `https://revue-de-presse.org/${dateStr}`;
                window.open(url, '_blank', 'noopener');
            }
        });

        // Inline start button (in headline area)
        const startBtnInline = document.getElementById('startBtnInline');
        if (startBtnInline) {
            startBtnInline.addEventListener('click', play);
        }

        document.getElementById('emailLink').addEventListener('click', (e) => {
            e.preventDefault();
            const user = 'contact+bonne-annee';
            const domain = 'revue-de-presse.org';
            window.location.href = 'mailto:' + user + '@' + domain;
        });

        // Dynamic copyleft year
        document.getElementById('copyleftYear').textContent = new Date().getFullYear();

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            // Slider: 100 (lent) -> 1000 (rapide)
            // Speed: 2200 - slider*2 = 2000ms (0.6x) -> 200ms (6x)
            // At 500 (center): speed = 1200ms = 1x
            speed = 2200 - parseInt(e.target.value) * 2;
            const speedMultiplier = (1200 / speed).toFixed(1);
            document.getElementById('speedLabel').textContent = `${speedMultiplier}x`;
            e.target.setAttribute('aria-valuenow', e.target.value);

            if (isPlaying) {
                pause();
                play();
            }
        });

        // Recalculer les scores cumules jusqu'a un index donne
        function recalculateScoresUpTo(targetIndex) {
            Object.keys(cumulativeScores).forEach(theme => cumulativeScores[theme] = 0);
            for (let i = 0; i <= targetIndex; i++) {
                allData[i].articles.forEach(article => {
                    const themes = classifyArticle(article.text);
                    const engagement = article.likes + (article.reposts * 2);
                    themes.forEach(theme => {
                        if (cumulativeScores[theme] !== undefined) {
                            cumulativeScores[theme] += engagement;
                        }
                    });
                });
            }
        }

        // Calculer les scores du jour uniquement (mode daily/swap)
        function calculateDailyScores(dayData) {
            const dailyScores = {};
            Object.keys(themeConfig).forEach(theme => dailyScores[theme] = 0);

            dayData.articles.forEach(article => {
                const themes = classifyArticle(article.text);
                const engagement = article.likes + (article.reposts * 2);
                themes.forEach(theme => {
                    if (dailyScores[theme] !== undefined) {
                        dailyScores[theme] += engagement;
                    }
                });
            });

            return dailyScores;
        }

        // Toggle animation mode
        function toggleAnimationMode() {
            const modeBtn = document.getElementById('modeBtn');
            const modeBtnLabel = document.getElementById('modeBtnLabel');
            const iconCumul = modeBtn.querySelector('.icon-cumul');
            const iconDaily = modeBtn.querySelector('.icon-daily');

            // Track if animation was playing to restart with new speed
            const wasPlaying = isPlaying;
            if (wasPlaying) {
                pause();
            }

            if (animationMode === 'cumulative') {
                animationMode = 'daily';
                modeBtn.classList.add('daily-mode');
                modeBtn.title = "Mode d'animation: Quotidien (vitesse rÃ©duite)";
                modeBtnLabel.textContent = 'Quotidien';
                iconCumul.style.display = 'none';
                iconDaily.style.display = 'block';
            } else {
                animationMode = 'cumulative';
                modeBtn.classList.remove('daily-mode');
                modeBtn.title = "Mode d'animation: Cumulatif";
                modeBtnLabel.textContent = 'Cumulatif';
                iconCumul.style.display = 'block';
                iconDaily.style.display = 'none';
            }

            // Recalculate and update chart with new mode
            if (allData.length > 0 && currentIndex >= 0) {
                if (animationMode === 'cumulative') {
                    recalculateScoresUpTo(currentIndex);
                }
                updateChart(allData[currentIndex], true);
            }

            // Restart animation with new speed if it was playing
            if (wasPlaying) {
                play();
            }
        }

        // Toggle scale mode (linear/log)
        function toggleScaleMode() {
            const scaleBtn = document.getElementById('scaleBtn');
            const scaleBtnLabel = document.getElementById('scaleBtnLabel');

            if (scaleMode === 'linear') {
                scaleMode = 'log';
                scaleBtn.classList.add('log-mode');
                scaleBtn.title = "Ã‰chelle: Logarithmique";
                scaleBtnLabel.textContent = 'Log';
            } else {
                scaleMode = 'linear';
                scaleBtn.classList.remove('log-mode');
                scaleBtn.title = "Ã‰chelle: LinÃ©aire";
                scaleBtnLabel.textContent = 'Lin';
            }

            // Update chart with new scale
            if (allData.length > 0 && currentIndex >= 0) {
                updateChart(allData[currentIndex], true);
            }
        }

        // Navigation temporelle
        function goToPreviousDay() {
            if (currentIndex > 0) {
                pause();
                currentIndex--;
                recalculateScoresUpTo(currentIndex);
                updateChart(allData[currentIndex], true);
                updateTimelineUI();
            }
        }

        function goToNextDay() {
            if (currentIndex < allData.length - 1) {
                pause();
                currentIndex++;
                recalculateScoresUpTo(currentIndex);
                updateChart(allData[currentIndex], true);
                updateTimelineUI();
            }
        }

        function goToStart() {
            pause();
            reset();
        }

        function goToEnd() {
            pause();
            currentIndex = allData.length - 1;
            // Recalculer tous les scores
            Object.keys(cumulativeScores).forEach(theme => cumulativeScores[theme] = 0);
            for (let i = 0; i <= currentIndex; i++) {
                allData[i].articles.forEach(article => {
                    const themes = classifyArticle(article.text);
                    const engagement = article.likes + (article.reposts * 2);
                    themes.forEach(theme => {
                        if (cumulativeScores[theme] !== undefined) {
                            cumulativeScores[theme] += engagement;
                        }
                    });
                });
            }
            updateChart(allData[currentIndex], false);
            updateTimelineUI();
        }

        // Modal aide clavier
        let helpModalVisible = false;

        function toggleHelpModal() {
            helpModalVisible = !helpModalVisible;
            let modal = document.getElementById('keyboardHelpModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'keyboardHelpModal';
                modal.innerHTML = `
                    <div class="help-modal-overlay" onclick="toggleHelpModal()"></div>
                    <div class="help-modal-content">
                        <h3>Raccourcis clavier</h3>
                        <div class="help-shortcuts">
                            <div class="shortcut-group">
                                <h4>Navigation</h4>
                                <div class="shortcut"><kbd>â†</kbd> ou <kbd>j</kbd> Jour prÃ©cÃ©dent</div>
                                <div class="shortcut"><kbd>â†’</kbd> ou <kbd>k</kbd> Jour suivant</div>
                                <div class="shortcut"><kbd>Home</kbd> DÃ©but</div>
                                <div class="shortcut"><kbd>End</kbd> Fin</div>
                            </div>
                            <div class="shortcut-group">
                                <h4>Lecture</h4>
                                <div class="shortcut"><kbd>Espace</kbd> Lecture / Pause</div>
                                <div class="shortcut"><kbd>r</kbd> Recommencer</div>
                            </div>
                            <div class="shortcut-group">
                                <h4>Options</h4>
                                <div class="shortcut"><kbd>s</kbd> ou <kbd>m</kbd> Son on/off</div>
                                <div class="shortcut"><kbd>c</kbd> Mode cumulatif/quotidien</div>
                                <div class="shortcut"><kbd>l</kbd> Ã‰chelle linÃ©aire/log</div>
                                <div class="shortcut"><kbd>+</kbd> AccÃ©lÃ©rer</div>
                                <div class="shortcut"><kbd>-</kbd> Ralentir</div>
                            </div>
                            <div class="shortcut-group">
                                <h4>Aide</h4>
                                <div class="shortcut"><kbd>?</kbd> Afficher/masquer cette aide</div>
                                <div class="shortcut"><kbd>Ã‰chap</kbd> Fermer</div>
                            </div>
                        </div>
                        <button onclick="toggleHelpModal()" class="help-close-btn" title="Fermer la fenÃªtre d'aide">Fermer</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.style.display = helpModalVisible ? 'flex' : 'none';
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
            // Ignorer si on est dans un champ de saisie
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case 'ArrowLeft':
                case 'j':
                    e.preventDefault();
                    goToPreviousDay();
                    break;
                case 'ArrowRight':
                case 'k':
                    e.preventDefault();
                    goToNextDay();
                    break;
                case ' ':
                    e.preventDefault();
                    isPlaying ? pause() : play();
                    break;
                case 'r':
                    e.preventDefault();
                    reset();
                    break;
                case 's':
                case 'm':
                    e.preventDefault();
                    toggleSound();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    const sliderUp = document.getElementById('speedSlider');
                    sliderUp.value = Math.min(parseInt(sliderUp.value) + 100, 1000);
                    sliderUp.dispatchEvent(new Event('input'));
                    break;
                case '-':
                    e.preventDefault();
                    const sliderDown = document.getElementById('speedSlider');
                    sliderDown.value = Math.max(parseInt(sliderDown.value) - 100, 100);
                    sliderDown.dispatchEvent(new Event('input'));
                    break;
                case 'Home':
                    e.preventDefault();
                    goToStart();
                    break;
                case 'End':
                    e.preventDefault();
                    goToEnd();
                    break;
                case '?':
                    e.preventDefault();
                    toggleHelpModal();
                    break;
                case 'c':
                    e.preventDefault();
                    toggleAnimationMode();
                    break;
                case 'l':
                    e.preventDefault();
                    toggleScaleMode();
                    break;
                case 'Escape':
                    if (helpModalVisible) {
                        e.preventDefault();
                        toggleHelpModal();
                    }
                    break;
            }
        });

        // ===== SHARE BUTTONS =====
        const pageUrl = window.location.href;
        const pageTitle = 'Revue de Presse 2025';
        const shareText = `Revue de Presse 2025
Articles de la presse franÃ§aise parmi les plus relayÃ©s en 2025

Revue-de-presse.org vous souhaite une excellente nouvelle annÃ©e 2026 !`;

        // Bluesky share
        document.getElementById('shareBluesky').addEventListener('click', (e) => {
            e.preventDefault();
            const text = `${shareText}\n\n${pageUrl}`;
            const bskyUrl = `https://bsky.app/intent/compose?text=${encodeURIComponent(text)}`;
            window.open(bskyUrl, '_blank', 'width=600,height=400');
        });

        // X (Twitter) share - disabled (RIP 2006-2023)
        // No event listener needed - button is non-interactive

        // Mastodon share (using share intent that prompts for instance)
        document.getElementById('shareMastodon').addEventListener('click', (e) => {
            e.preventDefault();
            const text = `${shareText}\n\n${pageUrl}`;
            const mastodonUrl = `https://mastodonshare.com/?text=${encodeURIComponent(text)}`;
            window.open(mastodonUrl, '_blank', 'width=600,height=500');
        });

        // LinkedIn share (URL only - LinkedIn uses page metadata for text)
        document.getElementById('shareLinkedIn').addEventListener('click', (e) => {
            e.preventDefault();
            const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`;
            window.open(linkedinUrl, '_blank', 'width=600,height=400');
        });

        // Email share
        document.getElementById('shareEmail').addEventListener('click', (e) => {
            e.preventDefault();
            const subject = encodeURIComponent(pageTitle);
            const body = encodeURIComponent(`${shareText}\n\n${pageUrl}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });

        // Signal share (Web Share API with clipboard fallback)
        document.getElementById('shareSignal').addEventListener('click', async (e) => {
            e.preventDefault();
            const text = `${shareText}\n\n${pageUrl}`;
            const shareData = {
                title: pageTitle,
                text: shareText,
                url: pageUrl
            };

            // Use Web Share API if available (lets user pick Signal from share sheet)
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    // User cancelled or share failed
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                        // Fallback to clipboard
                        await navigator.clipboard.writeText(text);
                        alert('Lien copiÃ© ! Collez-le dans Signal.');
                    }
                }
            } else {
                // Fallback: copy to clipboard for manual paste into Signal
                try {
                    await navigator.clipboard.writeText(text);
                    alert('Lien copiÃ© ! Collez-le dans Signal.');
                } catch (err) {
                    console.error('Clipboard failed:', err);
                }
            }
        });

        // Delta Chat share (uses mailto: - Delta Chat intercepts email intents)
        document.getElementById('shareDeltaChat').addEventListener('click', (e) => {
            e.preventDefault();
            const subject = encodeURIComponent(pageTitle);
            const body = encodeURIComponent(`${shareText}\n\n${pageUrl}`);
            // Delta Chat uses standard email protocol
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });

        // WhatsApp share
        document.getElementById('shareWhatsApp').addEventListener('click', (e) => {
            e.preventDefault();
            const text = `${shareText}\n\n${pageUrl}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
        });

        // Copy link
        document.getElementById('copyLink').addEventListener('click', async () => {
            const btn = document.getElementById('copyLink');
            const textSpan = document.getElementById('copyLinkText');
            try {
                await navigator.clipboard.writeText(pageUrl);
                btn.classList.add('copied');
                textSpan.textContent = 'CopiÃ© !';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    textSpan.textContent = 'Copier le lien';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = pageUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                btn.classList.add('copied');
                textSpan.textContent = 'CopiÃ© !';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    textSpan.textContent = 'Copier le lien';
                }, 2000);
            }
        });

        // ===== PUBLICATIONS POPUP =====
        const publicationsOverlay = document.getElementById('publicationsOverlay');
        const publicationsContent = document.getElementById('publicationsContent');
        const publicationsClose = document.getElementById('publicationsClose');
        const popupThemeTitle = document.getElementById('popupThemeTitle');
        const popupThemeIndicator = document.getElementById('popupThemeIndicator');

        function showPublicationsPopup(theme, color) {
            // Get keywords for this theme
            const keywords = themeConfig[theme]?.keywords || [];
            if (keywords.length === 0) return;

            // Set popup header
            popupThemeTitle.textContent = theme;
            popupThemeIndicator.style.backgroundColor = color;

            // Show loading state
            publicationsContent.innerHTML = '<div class="publications-loading">Chargement des publications...</div>';
            publicationsOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';

            // Find all articles matching this theme
            const matchingArticles = [];
            allData.forEach(dayData => {
                dayData.articles.forEach(article => {
                    const text = (article.text || '').toLowerCase();
                    const matches = keywords.some(kw => text.includes(kw.toLowerCase()));
                    if (matches && article.publication_id) {
                        matchingArticles.push({
                            ...article,
                            date: dayData.date
                        });
                    }
                });
            });

            // Sort by repost count (descending)
            matchingArticles.sort((a, b) => {
                return (b.reposts || 0) - (a.reposts || 0);
            });

            // Render publications
            if (matchingArticles.length === 0) {
                publicationsContent.innerHTML = '<div class="publications-empty">Aucune publication trouvÃ©e pour ce thÃ¨me.</div>';
                return;
            }

            // Calculate global median URL length for consistent truncation
            const allUrls = matchingArticles.flatMap(article => article.urls || []);
            const globalMedianLength = allUrls.length > 0 ? calculateMedian(allUrls.map(u => u.length)) : 60;

            let html = '';
            matchingArticles.forEach(article => {
                // Extract bsky URL from publication_id
                let bskyUrl = '#';
                if (article.publication_id) {
                    const match = article.publication_id.match(/at:\/\/(did:plc:[^/]+)\/app\.bsky\.feed\.post\/(.+)/);
                    if (match) {
                        bskyUrl = `https://bsky.app/profile/${match[1]}/post/${match[2]}`;
                    }
                }

                const date = new Date(article.date);
                const formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

                const engagement = (article.likes || 0) + (article.reposts || 0) * 2;

                // Use pre-extracted URLs from JSON (unfurled links preserved during build)
                const extractedUrls = article.urls || [];

                // Minimal runtime cleanup (ADR Phase 4: heavy lifting done at build time)
                const urlRegex = /(https?:\/\/[^\s<>"'\\]+)/g;
                const cleanedText = (article.text || '')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Remove any URLs from display text (they're shown as clickable links separately)
                const textWithoutUrls = cleanedText.replace(urlRegex, '').replace(/\s+/g, ' ').trim();

                // Build final text with truncated URLs as clickable links appended
                let linkifiedText = textWithoutUrls;
                if (extractedUrls.length > 0) {
                    const urlLinks = extractedUrls.map(url =>
                        `<a href="${url}" target="_blank" rel="noopener" class="publication-text-link" title="${url}">${truncateUrlForDisplay(url, globalMedianLength)}</a>`
                    ).join(' ');
                    linkifiedText = textWithoutUrls + (textWithoutUrls ? ' ' : '') + urlLinks;
                }

                // Known outlet avatar URLs (local copies for reliability)
                const outletAvatars = {
                    'telerama.bsky.social': 'assets/telerama-avatar.jpeg'
                };
                const avatarUrl = outletAvatars[article.screen_name] || article.avatar_url || '';

                html += `
                    <div class="publication-item">
                        <div class="publication-item-header">
                            <img src="${avatarUrl}"
                                 alt="${article.screen_name || ''}" class="publication-item-avatar" loading="lazy"
                                 onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                            <div class="publication-item-avatar-fallback" style="display:none;">${(article.screen_name || '?')[0].toUpperCase()}</div>
                            <div class="publication-item-meta">
                                <div class="publication-item-author">${article.screen_name || 'Inconnu'}</div>
                                <div class="publication-item-date">${formattedDate}</div>
                            </div>
                        </div>
                        <div class="publication-item-text">${linkifiedText}</div>
                        <div class="publication-item-footer">
                            <div class="publication-item-stats">
                                <span class="stat">
                                    <svg class="stat-icon repost" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                                    <span class="stat-value">${article.reposts || 0}</span>
                                </span>
                                <span class="stat">
                                    <svg class="stat-icon heart" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <span class="stat-value">${article.likes || 0}</span>
                                </span>
                            </div>
                            <a href="${bskyUrl}" target="_blank" rel="noopener" class="publication-item-link">
                                <svg class="bsky-logo" viewBox="0 0 568 501" fill="currentColor"><path d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873C309.719 181.681 379.759 82.5526 444.879 33.6637C491.866 -1.61183 568 -28.9064 568 57.9464C568 75.2916 558.055 203.659 552.222 224.501C531.947 296.954 458.067 315.434 392.347 304.249C507.222 323.8 536.444 388.56 473.333 453.32C353.473 576.312 301.061 422.461 287.631 383.039C285.169 372.163 284.017 367.108 284 368.119C283.983 367.108 282.831 372.163 280.369 383.039C266.939 422.461 214.527 576.312 94.6667 453.32C31.5556 388.56 60.7778 323.8 175.653 304.249C109.933 315.434 36.0535 296.954 15.7778 224.501C9.94525 203.659 0 75.2916 0 57.9464C0 -28.9064 76.1345 -1.61183 123.121 33.6637Z"/></svg>
                                Voir sur Bluesky
                            </a>
                        </div>
                    </div>
                `;
            });

            publicationsContent.innerHTML = html;
        }

        function hidePublicationsPopup() {
            publicationsOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }

        // Event delegation for link-count-btn clicks
        document.addEventListener('click', (e) => {
            const linkCountBtn = e.target.closest('.link-count-btn');
            if (linkCountBtn) {
                e.preventDefault();
                const theme = linkCountBtn.dataset.theme;
                const keywordGroup = linkCountBtn.closest('.keyword-group');
                const color = keywordGroup?.dataset.color || '#006663';
                showPublicationsPopup(theme, color);
                return;
            }
        });

        // Close popup handlers
        publicationsClose.addEventListener('click', hidePublicationsPopup);
        publicationsOverlay.addEventListener('click', (e) => {
            if (e.target === publicationsOverlay) {
                hidePublicationsPopup();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && publicationsOverlay.classList.contains('visible')) {
                hidePublicationsPopup();
            }
        });

        // ===== DARK MODE TOGGLE =====
        let darkModeEnabled = false;

        // Check for saved preference or system preference
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            darkModeEnabled = true;
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').classList.add('active');
            document.getElementById('themeBtn').setAttribute('aria-pressed', 'true');
        }

        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            const btn = document.getElementById('themeBtn');

            if (darkModeEnabled) {
                document.documentElement.setAttribute('data-theme', 'dark');
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                btn.setAttribute('title', 'Mode clair');
                btn.setAttribute('aria-label', 'Activer le mode clair');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                btn.setAttribute('title', 'Mode sombre');
                btn.setAttribute('aria-label', 'Activer le mode sombre');
                localStorage.setItem('theme', 'light');
            }
        }

        document.getElementById('themeBtn').addEventListener('click', toggleDarkMode);

        // ===== ACCESSIBILITY PATTERNS =====
        let patternsEnabled = true;
        // Apply patterns-enabled class on initial load
        document.body.classList.add('patterns-enabled');
        const patternDefs = `
            <defs id="accessibilityPatterns">
                <pattern id="pattern-stripe" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <line x1="0" y1="0" x2="0" y2="4" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
                </pattern>
                <pattern id="pattern-dots" width="4" height="4" patternUnits="userSpaceOnUse">
                    <circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.4)"/>
                </pattern>
                <pattern id="pattern-cross" width="6" height="6" patternUnits="userSpaceOnUse">
                    <line x1="0" y1="3" x2="6" y2="3" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                    <line x1="3" y1="0" x2="3" y2="6" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                </pattern>
                <pattern id="pattern-diagonal" width="6" height="6" patternUnits="userSpaceOnUse">
                    <line x1="0" y1="0" x2="6" y2="6" stroke="rgba(255,255,255,0.35)" stroke-width="1.5"/>
                </pattern>
                <pattern id="pattern-zigzag" width="8" height="4" patternUnits="userSpaceOnUse">
                    <polyline points="0,4 2,0 4,4 6,0 8,4" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
                </pattern>
                <pattern id="pattern-horizontal" width="4" height="4" patternUnits="userSpaceOnUse">
                    <line x1="0" y1="2" x2="4" y2="2" stroke="rgba(255,255,255,0.35)" stroke-width="1.5"/>
                </pattern>
                <pattern id="pattern-vertical" width="4" height="4" patternUnits="userSpaceOnUse">
                    <line x1="2" y1="0" x2="2" y2="4" stroke="rgba(255,255,255,0.35)" stroke-width="1.5"/>
                </pattern>
            </defs>
        `;

        // Pattern list - assigned by index to work with any theme names
        const patternList = [
            'url(#pattern-stripe)',
            'url(#pattern-dots)',
            'url(#pattern-cross)',
            'url(#pattern-diagonal)',
            'url(#pattern-zigzag)',
            'url(#pattern-horizontal)',
            'url(#pattern-vertical)'
        ];

        // Cache theme-to-pattern assignments
        const themePatternCache = {};
        let patternIndex = 0;

        function getPatternForTheme(theme) {
            if (!themePatternCache[theme]) {
                themePatternCache[theme] = patternList[patternIndex % patternList.length];
                patternIndex++;
            }
            return themePatternCache[theme];
        }

        function applyPatterns() {
            // Double-check patterns are still enabled (may have been toggled during animation)
            if (!patternsEnabled) return;

            const chartSvg = document.getElementById('chart');
            if (!chartSvg) return;

            // Add pattern defs if not present - use proper SVG namespace
            if (!document.getElementById('accessibilityPatterns')) {
                // Create a temporary container to parse SVG content properly
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg">${patternDefs}</svg>`;
                const defsEl = tempDiv.querySelector('defs');
                if (defsEl) {
                    chartSvg.insertBefore(defsEl, chartSvg.firstChild);
                }
            }

            // Apply patterns to bars
            document.querySelectorAll('.bar').forEach(barGroup => {
                const rect = barGroup.querySelector('rect:not(.pattern-overlay)');
                if (!rect) return;

                const theme = barGroup.__data__?.theme;
                if (!theme) return;

                // Remove existing overlay if any
                const existingOverlay = barGroup.querySelector('.pattern-overlay');
                if (existingOverlay) existingOverlay.remove();

                // Get current rect dimensions (check both attribute and computed style)
                let width = rect.getAttribute('width');
                let height = rect.getAttribute('height');
                const rx = rect.getAttribute('rx') || 0;

                // Fallback to getBBox for animated values
                if (!width || parseFloat(width) <= 0) {
                    try {
                        const bbox = rect.getBBox();
                        width = bbox.width;
                        height = bbox.height;
                    } catch (e) {
                        return; // Skip if can't get dimensions
                    }
                }

                // Only add overlay if bar has visible width
                if (parseFloat(width) > 0) {
                    const overlay = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    overlay.setAttribute('width', width);
                    overlay.setAttribute('height', height);
                    overlay.setAttribute('rx', rx);
                    overlay.setAttribute('fill', getPatternForTheme(theme));
                    overlay.setAttribute('class', 'pattern-overlay');
                    overlay.style.pointerEvents = 'none';
                    barGroup.appendChild(overlay);
                }
            });
        }

        function togglePatterns() {
            patternsEnabled = !patternsEnabled;
            const btn = document.getElementById('patternBtn');

            if (patternsEnabled) {
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                btn.setAttribute('title', 'DÃ©sactiver les motifs pour daltonisme');
                btn.setAttribute('aria-label', 'DÃ©sactiver les motifs pour daltonisme');
                document.body.classList.add('patterns-enabled');
                applyPatterns();
            } else {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                btn.setAttribute('title', 'Activer les motifs pour daltonisme');
                btn.setAttribute('aria-label', 'Activer les motifs pour daltonisme');
                document.body.classList.remove('patterns-enabled');
                // Remove pattern overlays
                document.querySelectorAll('.pattern-overlay').forEach(el => el.remove());
            }
        }

        document.getElementById('patternBtn').addEventListener('click', togglePatterns);
        document.getElementById('modeBtn').addEventListener('click', toggleAnimationMode);
        document.getElementById('scaleBtn').addEventListener('click', toggleScaleMode);

        // ===== JSON COPY LINK (for theme bsky links) =====
        document.addEventListener('click', (e) => {
            const jsonLink = e.target.closest('.json-copy-link');
            if (!jsonLink) return;

            e.preventDefault();
            const linksData = jsonLink.dataset.links;
            if (!linksData) return;

            // Parse and format JSON with indentation
            try {
                const links = JSON.parse(linksData.replace(/&quot;/g, '"'));
                const formattedJson = JSON.stringify(links, null, 2);

                navigator.clipboard.writeText(formattedJson).then(() => {
                    // Visual feedback
                    const originalText = jsonLink.textContent;
                    jsonLink.textContent = 'âœ“ copiÃ©';
                    jsonLink.classList.add('copied');

                    setTimeout(() => {
                        jsonLink.textContent = originalText;
                        jsonLink.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback: show in prompt
                    prompt('Copier les liens JSON:', formattedJson);
                });
            } catch (err) {
                console.error('Failed to parse links:', err);
            }
        });

        // ===== ZEN MODE TOGGLE =====
        const zenModeToggle = document.getElementById('zenModeToggle');
        const zenModeContent = document.getElementById('zenModeContent');

        if (zenModeToggle && zenModeContent) {
            zenModeToggle.addEventListener('click', () => {
                const isExpanded = zenModeToggle.getAttribute('aria-expanded') === 'true';
                zenModeToggle.setAttribute('aria-expanded', !isExpanded);
                zenModeToggle.classList.toggle('expanded');
                zenModeContent.classList.toggle('visible');

                // Update indicator text
                const indicator = zenModeToggle.querySelector('.toggle-indicator');
                if (indicator) {
                    indicator.textContent = isExpanded ? 'Afficher â–¼' : 'Masquer â–²';
                }
            });
        }

        // ===== FOLDABLE TOGGLE (keywords + methodology) =====
        // Use event delegation to handle dynamically created elements
        document.addEventListener('click', (e) => {
            const summary = e.target.closest('.keywords-foldable summary, .methodology-foldable summary');
            if (!summary) return;

            const details = summary.closest('details');
            const indicator = summary.querySelector('.toggle-indicator');

            if (indicator) {
                // Small delay to let the browser toggle the open state first
                setTimeout(() => {
                    indicator.textContent = details.open ? 'Masquer â–²' : 'Afficher â–¼';
                }, 0);
            }
        });

        // ===== WORD CLOUD POPUP =====
        // French stop words to exclude
        const stopWords = new Set(['le', 'la', 'les', 'un', 'une', 'des', 'de', 'du', 'au', 'aux', 'ce', 'cette', 'ces', 'son', 'sa', 'ses', 'mon', 'ma', 'mes', 'ton', 'ta', 'tes', 'notre', 'nos', 'votre', 'vos', 'leur', 'leurs', 'qui', 'que', 'quoi', 'dont', 'oÃ¹', 'et', 'ou', 'mais', 'donc', 'car', 'ni', 'pour', 'par', 'sur', 'sous', 'dans', 'avec', 'sans', 'chez', 'entre', 'vers', 'aprÃ¨s', 'avant', 'depuis', 'pendant', 'comme', 'plus', 'moins', 'trÃ¨s', 'trop', 'bien', 'mal', 'peu', 'beaucoup', 'tout', 'tous', 'toute', 'toutes', 'rien', 'quelque', 'chaque', 'autre', 'autres', 'mÃªme', 'mÃªmes', 'il', 'elle', 'ils', 'elles', 'on', 'nous', 'vous', 'je', 'tu', 'ne', 'pas', 'se', 'en', 'Ãªtre', 'avoir', 'faire', 'est', 'sont', 'Ã©tait', 'Ã©tÃ©', 'fait', 'dit', 'ans', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf', 'dix', 'cent', 'mille', 'premier', 'premiÃ¨re', 'aussi', 'ainsi', 'alors', 'encore', 'dÃ©jÃ ', 'ici', 'lÃ ', 'cela', 'celui', 'celle', 'ceux', 'celles', 'quand', 'comment', 'pourquoi', 'peut', 'peuvent', 'doit', 'doivent', 'veut', 'veulent', 'faut', 'selon', 'contre', 'lors', 'via', 'dÃ¨s', 'dont']);

        function extractWords(text) {
            // Normalize and split text
            const words = text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents for comparison
                .replace(/[^a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§\s-]/gi, ' ')
                .split(/\s+/)
                .filter(w => w.length > 3 && !stopWords.has(w.toLowerCase()));
            return words;
        }

        function buildWordCloud(articles, theme) {
            const wordCounts = {};

            articles.forEach(article => {
                const text = article.text || '';
                const words = extractWords(text);
                words.forEach(word => {
                    wordCounts[word] = (wordCounts[word] || 0) + 1;
                });
            });

            // Sort by count and take top 50
            const sorted = Object.entries(wordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);

            if (sorted.length === 0) return '<p>Aucun mot trouvÃ©</p>';

            const maxCount = sorted[0][1];
            const minCount = sorted[sorted.length - 1][1];
            const range = maxCount - minCount || 1;

            // Shuffle for visual variety
            sorted.sort(() => Math.random() - 0.5);

            return sorted.map(([word, count]) => {
                const normalized = (count - minCount) / range;
                const sizeClass = normalized > 0.8 ? 'size-5' :
                                  normalized > 0.6 ? 'size-4' :
                                  normalized > 0.4 ? 'size-3' :
                                  normalized > 0.2 ? 'size-2' : 'size-1';
                return `<span class="wordcloud-word ${sizeClass}" title="${count} occurrences">${word}</span>`;
            }).join('');
        }

        window.showWordCloud = function(weekKey, theme, weekNum) {
            // Find articles for this week
            // weekKey format: "2025-S10" - extract the week number
            const weekMatch = weekKey.match(/S(\d+)$/);
            const targetWeekNum = weekMatch ? parseInt(weekMatch[1]) : 0;

            const weekArticles = allData.filter(day => {
                const date = new Date(day.date);
                const dayWeek = getWeekNumber(date);
                return dayWeek === targetWeekNum;
            }).flatMap(day => day.articles || []);

            // Filter articles matching the theme (using themeConfig keywords)
            const themeKeywords = themeConfig[theme]?.keywords || [];
            const themeArticles = themeKeywords.length > 0
                ? weekArticles.filter(article => {
                    const text = (article.text || '').toLowerCase();
                    return themeKeywords.some(kw => text.includes(kw.toLowerCase()));
                })
                : weekArticles;

            // Build word cloud
            const articlesToUse = themeArticles.length > 0 ? themeArticles : weekArticles;
            let wordCloudHtml;

            if (articlesToUse.length === 0) {
                wordCloudHtml = '<p style="color: var(--text-muted); text-align: center;">DonnÃ©es en cours de chargement...<br>Veuillez rÃ©essayer dans quelques secondes.</p>';
            } else {
                wordCloudHtml = buildWordCloud(articlesToUse, theme);
            }

            document.getElementById('wordcloudTitle').textContent = theme;
            document.getElementById('wordcloudSubtitle').textContent = `Semaine ${weekNum} â€” ${articlesToUse.length} articles`;
            document.getElementById('wordcloudContent').innerHTML = wordCloudHtml;
            const overlay = document.getElementById('wordcloudOverlay');
            if (overlay) overlay.classList.add('visible');
        };

        // Initialize word cloud event listeners after DOM is ready
        setTimeout(() => {
            const wordcloudOverlay = document.getElementById('wordcloudOverlay');
            const wordcloudClose = document.getElementById('wordcloudClose');

            if (wordcloudClose) {
                wordcloudClose.addEventListener('click', () => {
                    if (wordcloudOverlay) wordcloudOverlay.classList.remove('visible');
                });
            }

            if (wordcloudOverlay) {
                wordcloudOverlay.addEventListener('click', (e) => {
                    if (e.target === wordcloudOverlay) {
                        wordcloudOverlay.classList.remove('visible');
                    }
                });
            }

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                const overlay = document.getElementById('wordcloudOverlay');
                if (e.key === 'Escape' && overlay && overlay.classList.contains('visible')) {
                    overlay.classList.remove('visible');
                }
            });
        }, 0);

        // ===== WEEK NAVIGATION =====
        const weekNav = document.getElementById('weekNav');
        if (weekNav && zenModeContent) {
            weekNav.addEventListener('click', (e) => {
                const navItem = e.target.closest('.week-nav-item');
                if (!navItem) return;

                e.preventDefault();
                const weekNum = navItem.dataset.week;
                const targetSection = document.getElementById('week-' + weekNum);

                if (targetSection && targetSection.style.display !== 'none') {
                    // Update active state
                    weekNav.querySelectorAll('.week-nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    navItem.classList.add('active');

                    // Scroll within the zen-mode-content container
                    const containerRect = zenModeContent.getBoundingClientRect();
                    const targetRect = targetSection.getBoundingClientRect();
                    const navHeight = weekNav.offsetHeight;
                    const scrollTop = zenModeContent.scrollTop + targetRect.top - containerRect.top - navHeight - 8;
                    zenModeContent.scrollTo({ top: scrollTop, behavior: 'smooth' });
                }
            });
        }


        // ===== SENTIMENT FILTER =====
        const sentimentFilter = document.getElementById('sentimentFilter');
        if (sentimentFilter) {
            sentimentFilter.addEventListener('click', (e) => {
                const btn = e.target.closest('.sentiment-filter-btn');
                if (!btn) return;

                const sentiment = btn.dataset.sentiment;
                const weekSections = document.querySelectorAll('.week-section');

                // Update active button state
                sentimentFilter.querySelectorAll('.sentiment-filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');

                // Show/hide weeks based on sentiment
                weekSections.forEach(section => {
                    const weekNum = section.dataset.weekNum;
                    const navItem = weekNav ? weekNav.querySelector(`.week-nav-item[data-week="${weekNum}"]`) : null;

                    if (sentiment === 'all' || section.dataset.sentiment === sentiment) {
                        section.style.display = '';
                        if (navItem) navItem.style.opacity = '';
                    } else {
                        section.style.display = 'none';
                        if (navItem) navItem.style.opacity = '0.3';
                    }
                });

                // Scroll to top of content when filter changes
                if (zenModeContent) {
                    zenModeContent.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        }

        // ===== SERVICE WORKER REGISTRATION =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates periodically (every 60 seconds)
                        setInterval(() => {
                            registration.update();
                        }, 60000);

                        // Listen for new service worker installing
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New content available, show update toast
                                        showUpdateToast();
                                    }
                                });
                            }
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });

            // Listen for controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // Reload to get fresh content
                window.location.reload();
            });
        }

        // Update available toast
        function showUpdateToast() {
            // Remove existing toast if any
            const existing = document.getElementById('updateToast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'updateToast';
            toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);color:#e8f5e9;padding:16px 20px;border-radius:12px;z-index:10000;font-family:system-ui,sans-serif;font-size:14px;box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:90%;width:400px;border:1px solid #3d7a4a;animation:slideUp 0.3s ease-out;';
            toast.innerHTML = `
                <style>
                    @keyframes slideUp {
                        from { transform: translateX(-50%) translateY(100%); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                    #updateToast button:hover { background: #2d5a3d !important; }
                </style>
                <div style="display:flex;align-items:center;gap:12px;">
                    <span style="font-size:24px;">ðŸ”„</span>
                    <div style="flex:1;">
                        <strong>Nouvelle version disponible</strong>
                        <p style="margin:4px 0 0;font-size:12px;opacity:0.9;">Actualiser pour voir les derniÃ¨res mises Ã  jour</p>
                    </div>
                    <button onclick="updateApp()" style="background:#1a472a;border:1px solid #4a8a5a;color:#e8f5e9;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:background 0.2s;">Actualiser</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#a5d6a7;font-size:20px;cursor:pointer;padding:0 0 0 4px;line-height:1;" title="Fermer">&times;</button>
                </div>
            `;
            document.body.appendChild(toast);
        }

        // Trigger service worker to skip waiting and activate
        function updateApp() {
            navigator.serviceWorker.getRegistration().then(registration => {
                if (registration && registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                } else {
                    // No waiting worker, just reload
                    window.location.reload();
                }
            }).catch(() => {
                window.location.reload();
            });
        }

        // Global error handler for debugging
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo);
            showErrorToast('<strong>Erreur\u00a0:</strong> ' + msg + '<br><small style="font-family:monospace;opacity:0.8;">' + url + ':' + lineNo + '</small>');
            return false;
        };

        // Error toast with revue-de-presse.org green branding and auto-dismiss
        function showErrorToast(message, duration = 10000) {
            // Remove existing toast if any
            const existing = document.getElementById('errorToast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'errorToast';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);color:#e8f5e9;padding:20px 24px 12px;border-radius:12px;z-index:10000;font-family:system-ui,sans-serif;font-size:13px;box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:90%;width:500px;border:1px solid #3d7a4a;';
            toast.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
                    <div style="flex:1;">
                        ${message}
                        <p style="margin:12px 0 0;font-size:11px;opacity:0.8;font-style:italic;">Aucun robot n'a Ã©tÃ© maltraitÃ© lors de la conception de cette application web.</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#a5d6a7;font-size:20px;cursor:pointer;padding:0;line-height:1;" title="Fermer">&times;</button>
                </div>
                <div style="margin-top:12px;height:3px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden;">
                    <div id="errorToastProgress" style="height:100%;background:#81c784;width:100%;transition:width linear;"></div>
                </div>
            `;
            document.body.appendChild(toast);

            // Animate progress bar
            const progressBar = document.getElementById('errorToastProgress');
            if (progressBar) {
                progressBar.style.transition = 'width ' + duration + 'ms linear';
                requestAnimationFrame(() => {
                    progressBar.style.width = '0%';
                });
            }

            // Auto-dismiss after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(-20px)';
                    toast.style.transition = 'opacity 0.3s, transform 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // Check for debug error mode (?error=1)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error') === '1') {
            showErrorToast('<strong>Erreur simulÃ©e</strong><br>Test du systÃ¨me de notification (paramÃ¨tre ?error=1)');
        }

        // Start loading with error handling
        loadData().catch(err => {
            console.error('Failed to load data:', err);
            showErrorToast('<strong>Erreur de chargement</strong><br>' + err.message + '<br><a href="javascript:location.reload()" style="color:#a5d6a7;text-decoration:underline;margin-top:8px;display:inline-block;">RÃ©essayer</a>', 15000);
        });
        }); // End DOMContentLoaded
    </script>

    <!-- Word cloud popup -->
    <div class="wordcloud-overlay" id="wordcloudOverlay" onclick="if(event.target === this) this.classList.remove('visible')">
        <div class="wordcloud-popup">
            <button class="wordcloud-close" id="wordcloudClose" title="Fermer" aria-label="Fermer le nuage de mots" onclick="document.getElementById('wordcloudOverlay').classList.remove('visible')">&times;</button>
            <div class="wordcloud-header">
                <h3 id="wordcloudTitle">Nuage de mots</h3>
                <p id="wordcloudSubtitle">Semaine X - ThÃ¨me</p>
            </div>
            <div class="wordcloud-content" id="wordcloudContent">
                <!-- Words will be inserted here -->
            </div>
        </div>
    </div>
</body>
</html>
